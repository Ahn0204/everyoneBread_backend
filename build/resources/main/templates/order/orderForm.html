<!--
******************************************
*  Created On : 2025. 12. 19.
*  File : productList.html
*******************************************
 -->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{main/main-layout}">
    <head>
        <th:block layout:fragment="head">
            <style>
                .heading {
                    font-weight: bold;
                    color: rgb(49, 49, 49);
                }
                textarea {
                    resize: none;
                    min-height: 30px;
                }
                .btn-primary {
                    --bs-btn-color: #fff;
                    --bs-btn-bg: cornflowerblue;
                    --bs-btn-border-color: cornflowerblue;
                    --bs-btn-hover-color: cornflowerblue;
                    --bs-btn-hover-bg: #fff;
                }
            </style>

            <!-- 포트원 API.js -->
            <!-- v1 -->
            <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
            <!-- v2 -->
            <!--<script type="text/javascript" src="https://cdn.portone.io/v2/browser-sdk.js"></script>-->
            <!-- 우편번호 서비스 -->
            <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
            <!--결제 api호출-->
            <script th:src="@{/js/order/portOne.js}"></script>
        </th:block>
    </head>
    <body>
        <!--레이아웃의 content 부분에 아래 내용이 출력됨-->
        <div layout:fragment="content">
            <!--주문 내역-->
            <div class="d-flex flex-column orderForm">
                <div class="orderForm heading">
                    <h2>주문/결제</h2>
                </div>

                <div class="orderFormBox border p-4 mt-1" style="width: 50vw; min-width: 450px">
                    <form th:object="${orderForm}" th:action="@{/order/order}" method="post" id="orderForm">
                        <!-- 유효성 검증에 에러 발생 시 에러 출력 -->
                        <div th:replace="~{comm/formErrors :: formErrorsFragment}"></div>
                        <div class="orderForm-productList mb-3">
                            <div class="d-flex flex-row gap-1">
                                <h6 class="heading">상품 정보</h6>
                                <span class="text-muted small">수정은 주문표에서 가능합니다.</span>
                            </div>
                            <!-- <div class="orderForm-productList"> -->
                            <input type="hidden" name="cart" class="cart" id="cart" />
                            <div class="cart-product border rounded p-3"></div>
                            <!-- </div> -->
                        </div>
                        <div class="orderForm-buyerInfo mb-3">
                            <h6 class="heading">주문자 정보</h6>
                            <div class="orderForm-buyerInfo-box border rounded p-3">
                                <label for="buyerName">이름</label>
                                <input type="text" class="buyerName mb-1" id="buyerName" name="buyerName" th:value="${#authentication.principal.member.memberName}" readonly />
                                <br />
                                <label for="buyerPhone">연락처</label>
                                <input type="text" class="buyerPhone" id="buyerPhone" name="orderPhone" th:value="${#authentication.principal.member.memberPhone}" readonly />
                                <input type="hidden" class="buyerMemberNo" id="buyerMemberNo" name="buyerMemberNo" th:value="${#authentication.principal.member.memberNo}" />
                            </div>
                        </div>
                        <div class="orderForm-orderAdress mb-3">
                            <h6 class="heading">배송 정보</h6>
                            <div class="orderForm-orderAdress-box d-flex flex-row border rounded p-3">
                                <div class="input-section" style="width: 80vw">
                                    <label for="addressAlias">별칭</label>
                                    <input type="text" class="addressAlias mb-1" id="addressAlias" value="회사" size="10" readonly />
                                    <!--배송변경목록 연결할 때까지 기본값 출력-->
                                    <br />
                                    <label for="orderAddress">주소</label>
                                    <br />
                                    <input type="text" class="orderAddress my-1" id="orderAddress" name="orderAddress" size="35" readonly />
                                    <br />
                                    <input type="text" class="orderAddress-2" id="orderAddress-2" name="orderAddress-2" size="25" placeholder="상세 주소 (동/호/층)" />
                                </div>
                                <div class="btn-section align-self-end" style="width: 20vw">
                                    <button type="button" class="btn btn-secondary address-change m-1" style="min-width: 80px">배송지 변경</button>
                                </div>
                            </div>
                        </div>
                        <div class="orderForm-request mb-3">
                            <h6 class="heading">가게 요청 사항</h6>
                            <div class="orderForm-request-box border rounded p-3 d-flex">
                                <textarea name="orderRequest" id="orderRequest" style="width: 100vw" placeholder="필수 항목이 아닙니다."></textarea>
                            </div>
                        </div>
                        <div class="orderForm-riderRequest mb-3">
                            <h6 class="heading">배달 요청 사항</h6>
                            <div class="orderForm-riderRequest-box border rounded p-3 d-flex">
                                <textarea name="riderRequest" id="riderRequest" style="width: 100vw" placeholder="필수 항목이 아닙니다."></textarea>
                            </div>
                        </div>
                        <div class="priceBox">
                            <div class="deliveryFee-box d-flex justify-content-between border-bottom border-2 mb-3">
                                <h6 class="heading">배송비</h6>
                                <div class="pe-2">
                                    <span class="deliveryFee" id="deliveryFee" th:text="${orderForm.deliveryFee}"></span>
                                    <span>원</span>
                                    <input type="hidden" name="deliveryFee" th:value="${orderForm.deliveryFee}" />
                                </div>
                            </div>
                            <div class="orderPrice-box d-flex justify-content-between">
                                <h5 class="heading">결제 금액</h5>
                                <div class="orderPrice-btn d-flex flex-row">
                                    <h4 class="orderPrice" id="orderPrice" name="orderPrice"></h4>
                                    <h4>원</h4>
                                    <input type="hidden" name="orderPrice" class="orderPrice" />
                                </div>
                            </div>
                            <div class="d-flex">
                                <button type="button" class="order btn btn-primary m-3 fw-bold" id="order" style="width: 50vw">결제</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!--레이아웃의 script 부분에 아래 내용이 출력됨-->
        <script layout:fragment="script">
            $(function () {
                //주문 내역의 shopNo
                showCart();
                //배송지 출력
                showAddress();
            });

            //cart 내역출력
            function showCart() {
                const shopNo = sessionStorage.getItem('shopNo');
                const cart = JSON.parse(sessionStorage.getItem('cart'));
                //총 결제 금액에 배송비 추가
                let orderPrice = Number($('#deliveryFee').text());
                if (cart) {
                    //장바구니에 값이 있다면
                    $('.cart-product').empty(); //이전 목록 삭제
                    //상품 내역 출력
                    cart.forEach((item) => {
                        $('.cart-product').append(`
                <div class="cart-item d-flex flex-row gap-2">
                    <div class="cart-name">${item.productName}</div>
                    <div class="text-muted small">|</div>
                    <div class="cart-price">${item.productPrice}원</div>
                    <div class="text-muted small">&times;</div>
                    <div class="cart-qty">${item.quantity}개</div>
                    </div>
                    `);
                        orderPrice += item.productPrice * item.quantity;
                    });
                    //총 결제 금액 출력
                    $('#orderPrice').text(orderPrice);
                    $('.orderPrice').val(orderPrice);
                    //상점 번호 출력
                    if (shopNo) {
                        $('.cart-product').append(`<input type="hidden" class="shopNo" id="shopNo" name="shopNo" value="` + shopNo + `"/>`);
                    } else {
                        showToast('다시 접속해주세요.');
                    }
                } else {
                    //장바구니가 비었다면
                    $('.cart-product').append('<div class="noCart"> 담긴 상품이 없습니다.</div>');
                    showToast('상품을 담은 후 주문이 가능합니다.');
                    $('#order').attr('disabled');
                }
            }

            //location에 저장된 address (배송지) 출력
            function showAddress() {
                const address = JSON.parse(sessionStorage.getItem('location')).addr;
                $('#orderAddress').val(address);
            }

            //결제 버튼 클릭 시 포트원 API 호출
            $('#order').on('click', function () {
                //유효성 검사
                const name = $('#buyerName').val().trim();
                const phone = $('#buyerPhone').val().trim();
                const address1 = $('#orderAddress').val().trim();
                const address2 = $('#orderAddress-2').val().trim();

                //입력값 유효성 검사
                if (!(name && phone && address1)) {
                    if (!phone || !name) {
                        showToast('다시 주문해주세요.', 'error');
                    } else if (!address1) {
                        $('#orderAddress').focus();
                    }
                    return;
                }

                //주문진행하는 함수
                function doCheckout() {
                    //주소 합치기
                    const address = address2 ? address1 + ' ' + address2 : address1;
                    $('#orderAddress').val(address);
                    const orderPrice = $('#orderPrice').text(); //총 결제 금액 가져오기
                    checkout(orderPrice); //결제 API를 호출하는 함수 호출 & DB에 기록 insert
                }

                //상세 주소 없을 때
                if (!address2) {
                    showConfirmAlert(
                        '상세 주소가 없습니다. \n주문을 진행하겠습니까?',
                        () => {
                            doCheckout();
                        },
                        () => {
                            return;
                        }
                    );
                    return;
                }

                //상세 주소 있을 때
                doCheckout();
            });
        </script>
    </body>
</html>
