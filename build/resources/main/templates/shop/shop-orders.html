<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{shop/common/shop-layout}">

<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" th:href="@{/css/shop/orders.css}">
    <!--예솔 추가 부트스트랩, sweetAlert-->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" /> -->
    <script th:src="@{/js/comm/sweetalert.noah.js}"></script>
        <!--csrf토근 헤더 추가-->
        <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}" />
        <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}" />
    <title>주문 관리 - 모두의빵 판매자센터</title>
</head>

<body>
<div layout:fragment="content">

    <div class="orders-container">

        <div class="page-title">주문 관리</div>

        <div>
            <!-- DASHBOARD 4개 박스 -->
             <div class="dashboard-box-wrapper">

                <div class="dashboard-box">
                    <div class="dash-title">오늘 주문</div>
                    <div class="dash-value" id="dash-today">0</div>
                </div>

                <div class="dashboard-box">
                    <div class="dash-title">대기 주문</div>
                    <div class="dash-value" id="dash-wait">0</div>
                </div>

                <div class="dashboard-box">
                    <div class="dash-title">배송 중</div>
                    <div class="dash-value" id="dash-delivering">0</div>
                </div>

                <div class="dashboard-box">
                    <div class="dash-title">완료 주문</div>
                    <div class="dash-value" id="dash-complete">0</div>
                </div>
        </div>

        <!-- 기간 필터 (더미 유지) -->
        <form class="top-controls">
            <input type="date" class="date-input">
            <span>~</span>
            <input type="date" class="date-input">
            <button type="button" class="btn">조회</button>
        </form>

        <!-- 상태 탭 (더미 유지) -->
        <div class="status-tabs">
            <!-- 전체 -->
            <a th:href="@{/shop/orders}"
            class="status-tab"
            th:classappend="${status == null} ? 'active'">
                전체
            </a>

            <!-- 대기 -->
            <a th:href="@{/shop/orders(status=WAIT)}"
            class="status-tab"
            th:classappend="${status != null and status.name() == 'WAIT'} ? 'active'">
                대기
            </a>

            <!-- 준비 -->
            <a th:href="@{/shop/orders(status=PREPARE)}"
            class="status-tab"
            th:classappend="${status != null and status.name() == 'PREPARE'} ? 'active'">
                준비
            </a>

            <!-- 배송중 -->
            <a th:href="@{/shop/orders(status=DELIVERING)}"
            class="status-tab"
            th:classappend="${status != null and status.name() == 'DELIVERING'} ? 'active'">
                배송중
            </a>

            <!-- 완료 -->
            <a th:href="@{/shop/orders(status=COMPLETE)}"
            class="status-tab"
            th:classappend="${status != null and status.name() == 'COMPLETE'} ? 'active'">
                완료
            </a>
        </div>

        <!-- ===== 주문 목록 ===== -->
        <!-- 주문이 없을 때 -->
        <div th:if="${#lists.isEmpty(orders)}" class="order-card">
            <div>주문이 없습니다.</div>
        </div>
        <!-- 주문이 있을 때 -->
        <div th:each="order : ${orders}" class="order-card" >
            <div class="order-row" th:onclick="|location.href='/shop/orders/${order.orderNo}'|" style="cursor:pointer;">

                <!-- 좌측: 주문 정보 -->
                <div class="order-left">
                    <div class="order-img">상품</div>

                    <div class="order-info">
                        <!-- 주문 날짜 -->
                        <div class="order-date"
                            th:text="${order.orderTime != null ? #temporals.format(order.orderTime.orderedAt, 'yyyy-MM-dd') : '-'}">
                        </div>

                        <!-- 상품 정보 -->
                        <div>
                            주문번호 :
                            <span th:text="${order.orderNo}"></span>
                        </div>

                        <!-- 총 금액 -->
                        <div>
                            총 금액 :
                            <span th:text="${#numbers.formatInteger(order.orderPrice, 3, 'COMMA')}"></span>원
                        </div>

                    </div>

                </div>
                
                <!-- 우측: 상태별 액션 -->
                <div class="order-actions">

                    <!-- 대기 -->
                    <th:block th:if="${order.status.name() == 'WAIT'}">
                        <form th:action="@{/shop/orders/{orderNo}/accept(orderNo=${order.orderNo})}"
                            method="post" onclick="event.stopPropagation();">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <button type="submit" class="btn">수락</button>
                        </form>

                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <button class="btn"
                                th:onclick="|openRejectModal(${order.orderNo})|" onclick="event.stopPropagation();">
                            거절
                        </button>
                    </th:block>

                    <!-- 준비 -->
                    <th:block th:if="${order.status.name() == 'PREPARE'}">
                        <span>상품 준비 중</span>
                    </th:block>

                    <!-- 배송중 -->
                    <th:block th:if="${order.status.name() == 'DELIVERING'}">
                        <span>배송 중</span>
                    </th:block>

                    <!-- 완료 -->
                    <th:block th:if="${order.status.name() == 'COMPLETE'}">
                        <span>배송 완료</span>
                    </th:block>

                    <!-- 거절 -->
                    <th:block th:if="${order.status.name() == 'REJECT'}">
                        <span class="text-reject">주문 거절</span>
                    </th:block>

                </div>
            </div>
                <!--관리자 문의-->
                <button class="btn btn-secondary orderInquiry" th:data-orderno="${order.orderNo}">관리자 문의</button>
        </div>


        <!-- 페이징 (더미) -->
        <div class="pagination">
            <a href="#">◀</a>
            <a href="#" class="current">1</a>
            <a href="#">2</a>
            <a href="#">▶</a>
        </div>

        <!--관리자 문의 모달-->
        <div id="modal-order-inquiry"></div>
    </div>
</div>

<!-- ===== 거절 모달 ===== -->
<div class="modal" id="rejectModal">
    <div class="modal-content">
        <h3>주문 거절</h3>

        <!-- 실제 서버 연동 시 action만 바꾸면 됨 -->
        <form method="post" id="rejectForm">
            <input type="hidden" name="orderNo" id="rejectOrderNo">
            <textarea name="reason" placeholder="거절 사유를 입력해주세요." required></textarea>

            <div class="modal-actions">
                <button type="button" class="btn" onclick="closeRejectModal()">취소</button>
                <button type="submit" class="btn">거절</button>
            </div>
        </form>
    </div>
</div>
<script th:src="@{/js/shop/orders.js}"></script>
</body>
</html>