<!-- shop-header fragment -->
<header th:fragment="shop-header"
        class="bg-body-tertiary position-sticky top-0"
        style="z-index:1030"
        xmlns:th="http://www.thymeleaf.org"
        xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

    <!-- shop header css -->
    <link rel="stylesheet" th:href="@{/css/shop/comm/header.css}">

    <!-- CSRF -->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>

    <nav class="navbar bg-body-tertiary">
        <div class="container-fluid">

            <!-- =========================
                 ì™¼ìª½ : ìƒì  ì •ë³´
            ========================== -->
            <div class="shop-header-left" onclick="location.href='/shop/'">
                <div class="shop-img-box">ìƒì </div>
                <div class="shop-name">ìƒì ëª…</div>
            </div>

            <!-- =========================
                 ê°€ìš´ë° : ë©”ë‰´ (ì •ì¤‘ì•™)
            ========================== -->
            <div class="shop-menu">
                <a href="/shop/products">ìƒí’ˆ ê´€ë¦¬</a>
                <a href="/shop/orders">ì£¼ë¬¸ ê´€ë¦¬</a>
                <a href="/shop/reviews">í›„ê¸° Â· ë¬¸ì˜</a>
            </div>

            <!-- =========================
                 ì˜¤ë¥¸ìª½ : ìœ ì € ì˜ì—­
            ========================== -->
            <div class="user-util" sec:authorize="isAuthenticated()">

                <!-- ğŸ”” ì•Œë¦¼ -->
                <div class="alert-wrapper">
                    <button id="alertBtn">
                        ì•Œë¦¼
                        <span class="alert-badge-count" style="display:none"></span>
                    </button>

                    <!-- ì•Œë¦¼ íŒ¨ë„ -->
                    <div class="alert-panel" id="alertPanel" style="display:none">

                        <!-- í—¤ë” -->
                        <div class="alert-header">
                            <span>ì•Œë¦¼</span>
                            <button type="button" class="alert-close" id="alertCloseBtn">âœ•</button>
                        </div>

                        <!-- íƒ­ -->
                        <div class="alert-tabs">
                            <button class="alert-tab active" data-tab="all">ì „ì²´</button>
                            <button class="alert-tab" data-tab="unread">ì½ì§€ì•ŠìŒ</button>
                        </div>

                        <!-- ë¦¬ìŠ¤íŠ¸ -->
                        <ul id="alertList">
                            <li class="alert-empty">ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>
                        </ul>
                    </div>
                </div>

                <!-- ë‚´ ì •ë³´ -->
                <button onclick="location.href='/shop/mypage'">ë‚´ ì •ë³´</button>

                <!-- ë¡œê·¸ì•„ì›ƒ -->
                <a href="/shop/logout">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
    </nav>

    <!-- =========================
         ì•Œë¦¼ JS
    ========================== -->
    <script>
        let currentTab = 'all';

        $(function () {
            getAlertCount();

            $('#alertBtn').on('click', function (e) {
                e.stopPropagation();
                $('#alertPanel').toggle();
                loadAlerts();
            });

            $('#alertCloseBtn').on('click', function () {
                $('#alertPanel').hide();
            });

            $(document).on('click', function () {
                $('#alertPanel').hide();
            });

            $('#alertPanel').on('click', function (e) {
                e.stopPropagation();
            });
        });

        // íƒ­ í´ë¦­
        $('.alert-tab').on('click', function () {
            $('.alert-tab').removeClass('active');
            $(this).addClass('active');
            currentTab = $(this).data('tab');
            loadAlerts();
        });

        // ì•Œë¦¼ ëª©ë¡
        function loadAlerts() {
            $('#alertList').empty();

            $.get('/alert/recent', { tab: currentTab }, function (alerts) {
                if (!alerts || alerts.length === 0) {
                    $('#alertList').append('<li class="alert-empty">ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>');
                    return;
                }
                alerts.forEach(a => $('#alertList').append(renderAlertItem(a)));
            });
        }

        function renderAlertItem(alert) {
            const li = $('<li>').addClass('alert-item').attr('data-alert-no', alert.alertNo);
            if (alert.readYn === 'N') li.addClass('unread');

            const row = $('<div>').addClass('alert-row');

            const text = $('<span>').addClass('alert-text')
                .append($('<a>').addClass('alert-link').attr('href', alert.linkUrl || '#').text(alert.content));

            const actions = $('<div>').addClass('alert-actions');

            if (alert.readYn === 'N') {
                actions.append($('<button>').addClass('alert-btn read').text('ì½ìŒ'));
            }
            actions.append($('<button>').addClass('alert-btn delete').text('ì‚­ì œ'));

            row.append(text, actions);
            li.append(row);
            return li;
        }

        $('#alertPanel').on('click', '.alert-btn.read', function () {
            const item = $(this).closest('.alert-item');
            $.post('/alert/readAlert', { alertNo: item.data('alert-no') }, ok => {
                if (ok) item.removeClass('unread').find('.read').remove();
            });
        });

        $('#alertPanel').on('click', '.alert-btn.delete', function () {
            const item = $(this).closest('.alert-item');
            $.post('/alert/deleteAlert', { alertNo: item.data('alert-no') }, ok => {
                if (ok) item.remove();
            });
        });

        function getAlertCount() {
            const badge = $('.alert-badge-count');
            $.post('/alert/ajaxCount', cnt => {
                if (cnt > 0) badge.text(cnt > 99 ? '99+' : cnt).show();
                else badge.hide();
            });
        }
    </script>
</header>
