<!--
******************************************
*  Created On : 2025. 12. 19.
*  File : productList.html
*******************************************
-->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{main/main-layout}">
    <head>
        <th:block layout:fragment="head">
            <!--css link태그 등 자식 페이지에서 head에 담겨야 할 태그-->
        </th:block>
    </head>
    <body>
        <!--레이아웃의 content 부분에 아래 내용이 출력됨-->
        <div layout:fragment="content">
            <!--상품 리스트-->
            <div class="d-flex row">
                <div class="listBox">
                    <!--상품 리스트 상부 - 상점 정보-->
                    <div class="shopInfo" th:object="${shop}">
                        <div class="shopName" th:text="${shop.shopName}"></div>
                        <!--shopNo-->
                        <input type="hidden" class="shopNo" id="shopNo" th:value="${shop.shopNo}" />
                        <input type="hidden" class="distance" id="distance" th:value="${shop.distance}" />
                    </div>
                    <!--상품 리스트 하부 - 상품 리스트-->
                    <div class="productList">
                        <div class="product" th:each="product:${productList}">
                            <!--상품 사진 url 경로 몰라서 주석 처리-->
                            <!-- <div><img th:src="@{|/${product.imgUrl}|}" alt="" /></div> -->
                            <div class="productName" th:text="${product.productName}"></div>
                            <div class="productPrice" th:text="${product.price}"></div>
                            <div class="productSummary" th:text="${product.summary}"></div>
                            <!--수량, 담기 버튼-->
                            <div class="beforeCart">
                                <input type="number" class="quantity" value="1" />
                                <button class="cartBtn btn btn-secondary" th:data-productno="${product.productNo}">담기</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!--장바구니/주문표-->
                <div th:replace="~{main/cartList}" class="cartList"></div>
            </div>
        </div>

        <!--레이아웃의 script 부분에 아래 내용이 출력됨-->
        <script layout:fragment="script">
            const shopNo = $('#shopNo').val(); //페이지의 상점 번호
            //장바구니 담기 버튼
            $('.cartBtn').on('click', function () {
                const cartShopNo = sessionStorage.getItem('shopNo'); //장바구니의 shopNo
                const cart = JSON.parse(sessionStorage.getItem('cart')); //장바구니
                const thisBtn = $(this);
                //세션스토리지에 'cart'가 없다면
                if (!cart) {
                    //cart생성
                    createCart(shopNo);
                    //장바구니에 product 추가
                    addCart(thisBtn);
                    //장바구니 출력
                    showCart();
                } else {
                    //세션스토리지에 'cart'가 있다면
                    if (cartShopNo != null && cartShopNo == shopNo) {
                        // shopNo가 일치한다면
                        addCart(thisBtn);
                        //장바구니 출력
                        showCart();
                    } else if (cartShopNo != null) {
                        // shopNo가 일치하지 않는다면
                        showConfirmAlert(
                            '다른 가게 주문이 담겨있습니다. 주문을 변경하시겠습니까?',
                            () => {
                                //예
                                //이전 cart 삭제
                                deleteCart();
                                //cart생성
                                createCart(shopNo);
                                //상품 추가
                                addCart();
                                //장바구니 출력
                                showCart();
                            },
                            () => {
                                //아니오
                                showToast('같은 가게 주문만 담을 수 있습니다.', 'error');
                            }
                        );
                    }
                }
            });

            //cart생성
            function createCart(shopNo) {
                // shopNo 저장
                sessionStorage.setItem('shopNo', shopNo);
                // 배열 'cart' 저장
                sessionStorage.setItem('cart', JSON.stringify([]));
            }

            //cart에 선택된 상품 추가
            function addCart(thisBtn) {
                //product정보
                const product = thisBtn.closest('.product');
                const productName = product.find('.productName').text();
                const productPrice = product.find('.productPrice').text();
                const quantity = thisBtn.siblings('.quantity').val();
                const productNo = thisBtn.data('productno');
                const data = { productNo, productName, productPrice, quantity };

                const cart = JSON.parse(sessionStorage.getItem('cart')); //장바구니
                //상품 일치여부 확인
                const existing = cart.find((c) => c.productNo === data.productNo);
                if (existing) {
                    //원래 있는 상품이라면
                    showToast('이미 추가된 상품입니다.', 'warning');
                } else {
                    //새로 추가하는 상품이라면
                    cart.push(data);
                    showToast('장바구니에 담았습니다.', 'success');
                }
                //장바구니 저장
                sessionStorage.setItem('cart', JSON.stringify(cart));
            }

            //cart출력
            function showCart() {
                //주문 내역의 shopNo
                const shopNo = sessionStorage.getItem('shopNo');
                const cart = JSON.parse(sessionStorage.getItem('cart'));
                let totalPrice = Number($('.deliveryFee').text()); //shop과 주문 위치 사이의 거리 기반 배송비...
                console.log(totalPrice);
                if (cart) {
                    //장바구니에 값이 있다면
                    $('.cart-product').empty(); //이전 목록 삭제
                    cart.forEach((item) => {
                        $('.cart-product').append(`
                    <div class="cart-item">
                        <div class="cart-name">${item.productName}</div>
                <div class="cart-qty">수량: ${item.quantity}</div>
                <div class="cart-price">${item.productPrice * item.quantity}원</div>
                </div>
                `);
                        totalPrice += item.productPrice * item.quantity;
                    });
                    //총 금액 출력
                    $('.cart-totalPrice').text(totalPrice + '원');
                    //주문 버튼 보이기
                    $('.orderBtn').removeAttr('disabled');
                } else {
                    //장바구니가 비었다면
                    $('.cart-product').append('<div class="noCart"> 담긴 상품이 없습니다.</div>');
                }
            }
        </script>
    </body>
</html>
