<div class="getLocation-box text-center">
    <div class="d-inline-flex p-3 align-items-center border">
        <i class="bi bi-geo-alt user_location fs-1 fw-bold me-2" title="내 위치 저장"></i>
        <div class="selectLocation me-2">
            <input type="text" class="address" size="40" placeholder="주소를 입력해주세요." />
        </div>
        <!-- <button class="search btn btn-dark">검색</button> -->
    </div>

    <!--카카오맵 활용해 위치 좌표얻기-->
    <script th:src="@{/js/main/location.js}"></script>
    <!--주소를 좌표로 변환해서 location에 등록-->
    <script th:src="@{/js/comm/getLngLat.js}"></script>
    <script type="text/javascript" th:inline="javascript">
        //페이지 로드 후
        $(function () {
            checkInitLocation();
        });

        //0. 세션에 저장된 location이 있는지 확인하는 함수
        function checkInitLocation() {
            console.log('0. 초기 작동 함수');
            //세션 스토리지에 위치 정보가 저장되어있다면
            if (sessionStorage.getItem('location') != null || sessionStorage.getItem('location') != undefined) {
                //세션스토리지에 값이 있다
                const location = JSON.parse(sessionStorage.getItem('location'));
                //location가져와서 input에 입력 후 검색시키기
                getShopList(location);

                //위치 정보 사용중 표시
                $('.user_location').removeClass('bi-geo-alt').addClass('bi-geo-alt-fill');
            } else {
                //세션스토리지에 값이 없음
                showConfirmAlert(
                    '위치 설정이 필요합니다. \n 현재 위치를 설정하겠습니까?',
                    () => {
                        getAutoLocation();
                    },
                    async () => {
                        await setDefaultLocation(); //기본위치 설정
                        showToast('기본 위치가 설정되었습니다.', 'info');
                    }
                );
            }
        }

        //사용자의 위치를 페이지에 반영 () (async, await 처리)
        $('.user_location').on('click', function () {
            //자동 위치 반영
            getAutoLocation();
        });

        //1. 자동으로 위치를 반영하는 함수
        function getAutoLocation() {
            showConfirmAlert(
                '현재 위치를 저장합니다.',
                async () => {
                    //예
                    try {
                        showToast('위치 정보를 반영중입니다', 'info', 5000);
                        //위치좌표 가져와서 주소로 변환
                        let radiusKm = 3.0; //검색 반경
                        const { lat, lng } = await getUserPosition(); //위도, 경도
                        let { addr } = await getAddress(lat, lng); //주소 문자열
                        let location = { lat: lat, lng: lng, addr: addr, radiusKm: radiusKm }; //위치 정보를 가진 객체
                        //(있을지도 모르는) 기존 location삭제
                        sessionStorage.removeItem('location');
                        //해당 좌표,주소를 세션에 저장
                        sessionStorage.setItem('location', JSON.stringify(location));
                        //위치 반영
                        $('.user_location').removeClass('bi-geo-alt').addClass('bi-geo-alt-fill');
                        getShopList(location);
                        showToast('위치 정보가 반영되었습니다', 'success');
                    } catch (error) {
                        console.log(error);
                        showToast('위치 정보를 사용할 수 없어 기본값으로 지정됩니다.', 'error');
                        await setDefaultLocation();
                    }
                },
                () => {
                    /*아니오*/
                }
            );
        }

        //1-2. 기본 위치 설정하기
        async function setDefaultLocation() {
            let radiusKm = 3.0; //검색 반경
            const defalutAddr = '서울 관악구 남부순환로 1820'; //기본 주소
            const { lat: defLat, lng: defLng } = await getLngLat(defalutAddr); //기본 위치 좌표
            //lat이라는 key 이름은 그대로 유지, 꺼내서 쓰는 변수명만 defLat / defLng로 바꾸는 것
            const defaultLocation = { lat: defLat, lng: defLng, addr: defalutAddr, radiusKm: radiusKm };
            //기본 location 저장
            sessionStorage.setItem('location', JSON.stringify(defaultLocation));
            //화면에 출력, 상점 검색
            getShopList(defaultLocation);
            showToast('기본 위치가 저장되었습니다.', 'success');
        }

        //2. 위치 기반으로 상점(상품) 검색하기 -> @param 위치정보가 key:value로 담긴 객체
        // 403에러 발생: 시큐리티 컨피그에서 ignoreMatcher로 해당 경로 설정, csrf토큰 생성 무시되도록함
        function getShopList(location) {
            //카테고리 value 전달
            const category = new URLSearchParams(window.location.search).get('category');
            //서버에 location값 전달
            $.ajax({
                url: '/getShopList',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ lat: location.lat, lng: location.lng, addr: location.addr, radiusKm: location.radiusKm, category: category }),
                success: function (shopList) {
                    //응답이 담긴 shopList.html 가져오기(fragment)
                    $('.shopList').html(shopList);
                    showToast('반경 ' + location.radiusKm + 'km 상점이 검색되었습니다.');
                    //주소input에 주소 입력
                    $('.address').val(location.addr);
                },
                error: function (error) {
                    showConfirmAlert(
                        '상점 목록을 가져올 수 없습니다. 주소를 직접 설정해주세요.',
                        () => {
                            //다음 우편번호 입력 창
                            searchAddress();
                        },
                        () => {}
                    );
                },
            });
        }

        //4. 위치 정보 초기화 (+ 세션 스토리지에 저장된 위치정보 삭제
        $(document).on('click', '.user_location.bi-geo-alt-fill', function () {
            showConfirmAlert(
                '위치 정보를 초기화합니다.', // 표시할 메시지
                async () => {
                    // 사용자가 '예'를 눌렀을 때 실행
                    sessionStorage.removeItem('location');
                    //위치 정보 삭제 표시
                    $('.user_location').removeClass('bi-geo-alt-fill').addClass('bi-geo-alt');
                    // 기본값 저장
                    await setDefaultLocation();
                },
                () => {
                    /*아니오*/
                }
            );
        });

        //주소input 클릭 시 주소 입력 후 상점 조회
        $('.address').on('click', function () {
            //우편번호 팝업 열기 = ( 주소 입력 + 상점 조회 )
            searchAddress();
        });

        //다음 우편번호 조회 팝업 열기
        function searchAddress() {
            new daum.Postcode({
                //*비동기 API 결과(우편번호api의 결과)를 쓰는 로직은 반드시 oncomplete 안에서 이어서 실행해야 한다
                //사용자가 입력한 주소 정보 리턴
                oncomplete: async function (data) {
                    //주소꺼내기
                    const addr = data.roadAddress || data.jibunAddress || data.autoRoadAddress || data.autoJibunAddress;
                    $('.address').val(addr);
                    //주소 기준 상점 조회
                    await searchShopList();
                },
            }).open();
        }

        //주소 입력창 input에 입력된 주소 기준 상점 조회
        async function searchShopList() {
            showToast('위치 정보를 반영중입니다', 'info', 5000);
            //위치좌표 가져와서 주소로 변환
            let radiusKm = 3.0; //검색 반경
            let addr = $('.address').val(); //입력된 주소
            const { lat, lng } = await getLngLat(addr); //위도, 경도
            let location = { lat: lat, lng: lng, addr: addr, radiusKm: radiusKm }; //위치 정보를 가진 객체
            //(있을지도 모르는) 기존 location삭제
            sessionStorage.removeItem('location');
            //해당 좌표,주소를 세션에 저장
            sessionStorage.setItem('location', JSON.stringify(location));
            //위치 반영
            $('.user_location').removeClass('bi-geo-alt').addClass('bi-geo-alt-fill');
            //상점 조회
            getShopList(location);
            showToast('위치 정보가 반영되었습니다', 'success');
        }

        //상점으로 이동 시 사용자 좌표 전달
        function goShop(shopNo) {
            console.log('상점 이동');
            const loc = JSON.parse(sessionStorage.getItem('location'));
            const lat = loc.lat;
            const lng = loc.lng;

            if (!lat || !lng) {
                console.error('위치 정보 없음');
                return;
            }

            location.href = `/shopList/productList/${shopNo}?lat=${lat}&lng=${lng}`;
        }
    </script>
</div>
