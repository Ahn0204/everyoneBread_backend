<div class="alert-wrapper">
    <button class="btn btn-secondary util-alert pb-2" id="alertBtn">
        ì•Œë¦¼í•¨
        <span class="alert-badge-count" style="display: none"></span>
    </button>

    <!-- ğŸ”” ì•Œë¦¼ íŒ¨ë„ -->
    <div class="alert-panel" id="alertPanel" style="display: none">
        <div class="d-flex justify-content-between align-items-center">
            <span class="p-2 fw-bold">ì•Œë¦¼</span>
            <button type="button" class="btn-close btn-sm me-1" id="alertCloseBtn"></button>
        </div>
        <div class="border-bottom gap-1 fs-6">
            <div class="alert-tabs d-flex border-bottom">
                <button class="alert-tab active" data-tab="all">ì „ì²´</button>
                <button class="alert-tab" data-tab="unread">ì½ì§€ì•ŠìŒ</button>
            </div>
        </div>
        <ul class="list-unstyled m-0" id="alertList">
            <li class="p-2 text-muted">ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>
            <li class="alert-item">
                <div class="alert-row">
                    <!-- ì™¼ìª½: ì•Œë¦¼ ë‚´ìš© -->
                    <span class="alert-text"><a href="#">ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.</a></span>

                    <!-- ì˜¤ë¥¸ìª½: ì•¡ì…˜ -->
                    <div class="alert-actions">
                        <button type="button" class="alert-btn read">ì½ìŒ</button>
                        <button type="button" class="alert-btn delete">ì‚­ì œ</button>
                    </div>
                </div>
            </li>
            <li class="alert-item unread">
                <div class="alert-row">
                    <!-- ì™¼ìª½: ì•Œë¦¼ ë‚´ìš© -->
                    <span class="alert-text"><a href="#">ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.</a></span>

                    <!-- ì˜¤ë¥¸ìª½: ì•¡ì…˜ -->
                    <div class="alert-actions">
                        <button type="button" class="alert-btn read">ì½ìŒ</button>
                        <button type="button" class="alert-btn delete">ì‚­ì œ</button>
                    </div>
                </div>
            </li>
            <li class="alert-item unread">
                <div class="alert-row">
                    <!-- ì™¼ìª½: ì•Œë¦¼ ë‚´ìš© -->
                    <span class="alert-text"><a href="#">ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.</a></span>

                    <!-- ì˜¤ë¥¸ìª½: ì•¡ì…˜ -->
                    <div class="alert-actions"></div>
                </div>
            </li>
        </ul>
    </div>
</div>
<script>
    // tab í™”ë©´ ì „í™˜ìš© ë³€ìˆ˜
    let currentTab = 'all';
    // ë¬´í•œ ìŠ¤í¬ë¡¤ìš© lastAlertNo
    let lastAlertNo = null;
    let isLoading = false; // ì§€ê¸ˆ ìš”ì²­ ì¤‘ì¸ê°€?
    let hasMore = true; // ë” ë¶ˆëŸ¬ì˜¬ ë°ì´í„°ê°€ ìˆëŠ”ê°€?

    $(function () {
        test();
        // ì½ì§€ ì•Šì€ ì•Œë¦¼ ì¹´ìš´íŠ¸
        getAlertCount();
        // ì•Œë¦¼ ë²„íŠ¼ í´ë¦­ â†’ í† ê¸€
        $('#alertBtn').on('click', function (e) {
            e.stopPropagation();
            $('#alertPanel').toggle();
            loadAlerts();
        });

        // ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
        $(document).on('click', function () {
            $('#alertPanel').hide();
        });

        $('#alertCloseBtn').on('click', function (e) {
            e.stopPropagation();
            $('#alertPanel').toggle();
        });

        // íŒ¨ë„ ë‚´ë¶€ í´ë¦­ ì‹œ ë‹«íˆì§€ ì•Šê²Œ
        $('#alertPanel').on('click', function (e) {
            e.stopPropagation();
        });
    });

    function test() {
        const data = {
            shoppingCart: {
                shopNo: 1,
                products: [
                    { productNo: 101, productName: 'ì‹ë¹µ', category: 'BREAD', productPrice: 3000 },
                    {
                        productNo: 102,
                        productName: 'í¬ë£¨ì•„ìƒ',
                        category: 'BREAD',
                        productPrice: 3500,
                    },
                    {
                        productNo: 103,
                        productName: 'ì¹˜ì¦ˆì¼€ì´í¬',
                        category: 'DESSERT',
                        productPrice: 5000,
                    },
                ],
            },
        };
        console.log(data);
    }

    // íƒ­ í´ë¦­ì‹œ
    $('.alert-tab').on('click', function () {
        $('.alert-tab').removeClass('active');
        $(this).addClass('active');
        currentTab = $(this).data('tab');
        lastAlertNo = null;
        isLoading = false;
        hasMore = true;

        loadAlerts();
    });

    function loadAlerts() {
        $('#alertList').empty();
        $.ajax({
            url: '/alert/recent',
            type: 'GET',
            data: { tab: currentTab },
            success: function (alerts) {
                if (!alerts || alerts.length === 0) {
                    $('#alertList').append('<li class="p-2 text-muted">ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>');
                    return;
                }

                alerts.forEach((alert) => {
                    $('#alertList').append(renderAlertItem(alert));
                });

                lastAlertNo = alerts[alerts.length - 1].alertNo;
            },
        });
    }

    function renderAlertItem(alert) {
        const li = $('<li>').addClass('alert-item').attr('data-alert-no', alert.alertNo);
        if (alert.readYn == 'N') {
            li.addClass('unread');
        }

        const row = $('<div>').addClass('alert-row');

        // ì™¼ìª½: ì•Œë¦¼ ë‚´ìš©
        const text = $('<span>')
            .addClass('alert-text')
            .append(
                $('<a>')
                    .addClass('alert-link')
                    .attr('href', alert.linkUrl || '#')
                    .text(alert.content)
            );

        const time = $('<span>').addClass('alert-time');
        time.text(alert.createdAt);

        // // ì˜¤ë¥¸ìª½: ì•¡ì…˜ ë²„íŠ¼
        // const actions = $('<div>').addClass('alert-actions');
        // // âœ… ì½ì§€ ì•Šì€ ì•Œë¦¼ë§Œ ì½ìŒ ë²„íŠ¼ ìƒì„±
        // if (alert.readYn === 'N') {
        //     const readBtn = $('<button>').attr('type', 'button').addClass('alert-btn read').text('ì½ìŒ');
        //     actions.append(readBtn);
        // }
        // const deleteBtn = $('<button>').attr('type', 'button').addClass('alert-btn delete').text('ì‚­ì œ');

        // actions.append(deleteBtn);
        // row.append(text, actions);
        row.append(text, time);
        li.append(row);

        return li;
    }

    // ì½ê¸° ë²„íŠ¼
    $('#alertPanel').on('click', '.alert-btn.read', function () {
        const alertItem = $(this).closest('.alert-item');
        const alertNo = $(this).closest('.alert-item').data('alert-no');
        readAlert(alertNo, function (result) {
            if (currentTab == 'unread') {
                alertItem.remove();
                return;
            }
            if (result === true) {
                alertItem.removeClass('unread');
                alertItem.find('.alert-btn.read').remove();
            }
        });
    });

    // ì‚­ì œ ë²„íŠ¼
    $('#alertPanel').on('click', '.alert-btn.delete', function () {
        const alertItem = $(this).closest('.alert-item');
        const alertNo = $(this).closest('.alert-item').data('alert-no');
        $.ajax({
            url: '/alert/deleteAlert',
            type: 'POST',
            data: { alertNo },
            success: function (response) {
                if (response) {
                    alertItem.remove();
                    showToast('ì•Œë¦¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } else {
                    showToast('ì•Œë¦¼ì„ ì‚­ì œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤', 'error');
                }
            },
            error: function (xhr, status, msg) {
                console.error('ì‚­ì œ ì˜¤ë¥˜');
                console.error(xhr);
                console.error(status);
                console.error(msg);
            },
        });
    });

    function readAlert(alertNo, callback) {
        $.ajax({
            url: '/alert/readAlert',
            type: 'POST',
            data: { alertNo },
            success: function (response) {
                callback(response); // ì—¬ê¸°ì„œ ê²°ê³¼ ì „ë‹¬
            },
            error: function (xhr, status, msg) {
                callback(false);
            },
        });
    }

    // ë¬´í•œ ìŠ¤í¬ë¡¤
    $('#alertList').on('scroll', function () {
        if (!hasMore || isLoading) return;
        if (isBottom(this)) {
            loadMoreAlerts();
        }
    });

    function isBottom(element) {
        return element.scrollTop + element.clientHeight >= element.scrollHeight - 5;
    }

    function loadMoreAlerts() {
        if (!lastAlertNo) return;
        if (isLoading || !hasMore) return;

        isLoading = true;
        $.ajax({
            url: '/alert/recent/scroll',
            type: 'POST',
            data: {
                tab: currentTab,
                lastAlertNo: lastAlertNo,
            },
            success: function (alerts) {
                if (!alerts || alerts.length === 0) {
                    $('#alertList').append('<li class="p-2 text-muted">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>');
                    hasMore = false;
                    return;
                }

                alerts.forEach((alert) => {
                    $('#alertList').append(renderAlertItem(alert));
                });

                lastAlertNo = alerts[alerts.length - 1].alertNo;
            },
            complete: function () {
                isLoading = false;
            },
        });
    }

    // a íƒœê·¸ í´ë¦­ì‹œ ì½ìŒ ì²˜ë¦¬ í›„ í˜ì´ì§€ ì´ë™
    $('#alertPanel').on('click', '.alert-link', function (e) {
        e.preventDefault(); // â­ ê¸°ë³¸ ì´ë™ ë§‰ê¸°

        const linkUrl = $(this).attr('href');
        const alertItem = $(this).closest('.alert-item');
        const alertNo = alertItem.data('alert-no');
        const badge = $('.alert-badge-count');
        // ì´ë¯¸ ì½ì€ ì•Œë¦¼ì´ë©´ ë°”ë¡œ ì´ë™
        if (!alertItem.hasClass('unread')) {
            location.href = linkUrl;
            return;
        }

        // ì½ìŒ ì²˜ë¦¬ í›„ ì´ë™
        readAlert(alertNo, function (result) {
            if (result === true) {
                alertItem.removeClass('unread');
                const beforeCount = badge.attr('data-badge-count');
                const afterCount = beforeCount - 1;
                badge.attr('data-badge-count', afterCount);
                if (afterCount == 0) {
                    badge.text(afterCount);
                    badge.hide();
                    return;
                }
                if (afterCount < 100) {
                    badge.text(afterCount);
                    return;
                }
            }
            // location.href = linkUrl; // â­ ì²˜ë¦¬ í›„ ì´ë™
        });
    });

    // ì½ì§€ ì•Šì€ ì•Œë¦¼ ê°¯ìˆ˜ ê°€ì ¸ì˜¤ê¸°
    function getAlertCount() {
        const $badge = $('.alert-badge-count');
        $.ajax({
            url: '/alert/ajaxCount',
            type: 'POST',
            beforeSend: function (xhr) {
                const token = $("meta[name='_csrf']").attr('content');
                const header = $("meta[name='_csrf_header']").attr('content');
                xhr.setRequestHeader(header, token);
            },
            success: function (response) {
                console.log('alert Count : ' + response);
                $badge.attr('data-badge-count', response);

                if (response == 0) {
                    $badge.hide();
                    return;
                }
                if (response <= 99) {
                    $badge.text(response).show();
                    return;
                }
                if (response >= 100) {
                    $badge.text('99+').show();
                    return;
                }
            },
            error: function (xhr, status, msg) {
                console.error(xhr);
                console.error(status);
                console.error(msg);
            },
        });
    }
</script>
