<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{member/mypage/mypage-layout}">

<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>ì¦ê²¨ì°¾ê¸°</title>
    <style>
        .wish-title { font-size: 22px; font-weight: 700; margin-bottom: 25px; }
        .wish-item { display: flex; border: 2px solid #000; background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 25px; align-items: center; }
        /* ì™¼ìª½ ê°€ê²Œ ì´ë¯¸ì§€ */
        .wish-img-box { width: 120px; height: 120px; border-radius: 12px; overflow: hidden; border: 1px solid #ddd; margin-right: 20px; }
        .wish-img-box img { width: 100%; height: 100%; object-fit: cover; }
        /* ìƒì  ì •ë³´ */
        .wish-info { flex: 1; }
        .wish-name { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
        .wish-desc { font-size: 14px; color: #555; }
        /* ì˜¤ë¥¸ìª½ ì¦ê²¨ì°¾ê¸° ë²„íŠ¼(í•˜íŠ¸) */
        .wish-heart { width: 26px; height: 26px; cursor: pointer; }
        /* ë¹ˆ ëª©ë¡ ì•ˆë‚´ ë¬¸êµ¬ */
        .empty-text { text-align: center; color: #777; padding: 60px 0; font-size: 15px; }
    </style>
</head>

<body>

<section layout:fragment="mypage-content" id="wishlist-container">

    <h2 class="wish-title">ì¦ê²¨ì°¾ê¸°</h2>

    <!-- ì¦ê²¨ì°¾ê¸° ëª©ë¡ì´ ë¹„ì–´ ìˆì„ ë•Œ -->
    <div th:if="${#lists.isEmpty(wishlist)}" class="empty-text">
        ì•„ì§ ì¦ê²¨ì°¾ê¸°í•œ ë¹µì§‘ì´ ì—†ì–´ìš” ğŸ<br>
        ë§ˆìŒì— ë“œëŠ” ë¹µì§‘ì„ ì°œí•´ë³´ì„¸ìš”!
    </div>

    <!-- ì¦ê²¨ì°¾ê¸° ëª©ë¡ ì¶œë ¥ -->
    <th:block th:each="wish : ${wishlist}">
        <div class="wish-item">

            <!-- ìƒì  ì´ë¯¸ì§€ -->
            <div class="wish-img-box">
                <img th:src="@{${wish.shopImg}}" alt="ê°€ê²Œ ì‚¬ì§„">
            </div>

            <!-- ìƒì  ì •ë³´ -->
            <div class="wish-info">
                <div class="wish-name" th:text="${wish.shopName}">
                    ê°€ê²Œì´ë¦„
                </div>
                <div class="wish-desc" th:text="${wish.description}">
                    ê°€ê²Œ ì„¤ëª…
                </div>
            </div>

            <!-- ì°œ í•´ì œ ë²„íŠ¼ -->
            <img class="wish-heart"
                 src="/images/icon/heart-fill.png"
                 alt="ì¦ê²¨ì°¾ê¸° í•´ì œ"
                 th:attr="data-shopNo=${wish.shopNo}"
                 onclick="toggleWish(this)">
        </div>
    </th:block>
</section>
<script>
    const csrfToken  = document.querySelector('meta[name="_csrf"]').content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
    /**
     * ì¦ê²¨ì°¾ê¸°(ì°œ) í† ê¸€ ì²˜ë¦¬
     * - í•˜íŠ¸ í´ë¦­ ì‹œ í˜¸ì¶œ
     * - ì„œë²„ì— shopNo ì „ë‹¬
     * - DELETEDë©´ ì¹´ë“œ ì œê±°
     */
    function toggleWish(el) {
        
        // ì¤‘ë³µ í´ë¦­ ë°©ì§€
        el.style.pointerEvents = 'none';

        // 1ï¸. í´ë¦­ëœ í•˜íŠ¸ì—ì„œ ìƒì  ë²ˆí˜¸ ì¶”ì¶œ
        const shopNo = el.dataset.shopno;

        // 2ï¸. ì„œë²„ì— í† ê¸€ ìš”ì²­
        fetch('/wishlist/toggle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify({
                shopNo: shopNo
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('ì°œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
            return response.json();
        })
        .then(data => {

            // 3ï¸. ì„œë²„ ì‘ë‹µ ìƒíƒœ í™•ì¸
            // status: ACTIVE / DELETED
            if (data.status === 'DELETED') {

                // ë§ˆì´í˜ì´ì§€ì—ì„œëŠ” ì°œ í•´ì œ ì‹œ ì¹´ë“œ ì œê±°
                const wishItem = el.closest('.wish-item');
                wishItem.remove();

                // ì°œ ëª©ë¡ì´ ëª¨ë‘ ì‚¬ë¼ì¡Œë‹¤ë©´ ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ
                if (document.querySelectorAll('.wish-item').length === 0) {
                    showEmptyMessage();
                }
            }

            // ACTIVEì¸ ê²½ìš° (ë§ˆì´í˜ì´ì§€ì—ì„œëŠ” íŠ¹ë³„í•œ ì²˜ë¦¬ ì—†ìŒ)
        })
        .catch(error => {
            console.error(error);
            alert('ì¦ê²¨ì°¾ê¸° ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    /**
     * ì¦ê²¨ì°¾ê¸° ëª©ë¡ì´ ë¹„ì—ˆì„ ë•Œ ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ
     */
    function showEmptyMessage() {

        // id ê¸°ë°˜ DOM ì ‘ê·¼
        const container = document.getElementById('wishlist-container');

        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'empty-text';
        emptyDiv.innerHTML = `
            ì•„ì§ ì¦ê²¨ì°¾ê¸°í•œ ë¹µì§‘ì´ ì—†ì–´ìš” ğŸ<br>
            ë§ˆìŒì— ë“œëŠ” ë¹µì§‘ì„ ì°œí•´ë³´ì„¸ìš”!
        `;

        container.appendChild(emptyDiv);
    }
</script>
</body>
</html>