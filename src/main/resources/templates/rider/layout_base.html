<!--
******************************************
*  Created On : 2025. 11. 25.
*  File : layout_base.html
*******************************************
 -->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="_csrf" th:content="${_csrf.token}" />
        <meta name="_csrf_header" th:content="${_csrf.headerName}" />
        <!-- JQuery CDN -->
        <script src="https://code.jquery.com/jquery-latest.min.js"></script>
        <!-- SweetAlert2 CDN -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <!-- BootStrap CDN -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" />
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0&icon_names=favorite" />
        <link rel="stylesheet" th:href="@{css/rider/order.css}" />
        <title>모두의 빵</title>
        <style>
            html,
            body {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
            }

            body {
                display: flex;
                justify-content: center; /* 가로 중앙 */
                align-items: center; /* 세로 중앙 */
                background: #f4f4f4; /* 선택 */
            }
            /* 페이지 전체 레이아웃 컨테이너 (사이드바 + 메인) */
            .layout-wrapper {
                display: flex;
                flex-direction: row;
                min-width: 1000px;
                width: 90vw;
                height: 90vh;
                border: 1px solid black;
            }
            /* 사이드바 영역 */
            .wrapper-sidebar {
                min-width: 300px;
                flex: 2.5;
                height: 100%;
                border: 1px solid red;
                display: flex;
                flex-direction: column;
            }

            .sidebar-top {
                flex: none; /* flex에 의한 비율 무효화 */
                height: 20%; /* 부모 높이의 20% 정확히 */
                padding: 10px; /* 상하좌우 10px */
                box-sizing: border-box;
                display: flex;
                align-items: center;
                flex-direction: column;
            }

            .top-timezone {
                margin: 5px 10px;
                font-size: 30px;
                font-weight: 700;
                color: #e0e0e0; /* 글씨 흰색 */
                width: 100%;
                height: 50%;
                display: flex;
                justify-content: center;
                align-items: center;
                background-color: #444;
                border-radius: 6px;
            }

            .top-delivery-info {
                border: 1px solid black;
                padding: 10px;
                width: 100%;
                height: 50%;
                align-items: center;
            }

            .top-delivery-info {
                font-weight: bold;
                background-color: #444; /* 어두운 배경 */
                border-radius: 8px;
                text-align: center;
                color: #fff;
                display: flex;
                flex-direction: row;
                justify-content: space-between;
            }

            .timeline {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: #111;
                padding: 10px 15px;
                border-radius: 10px;
                gap: 20px;
            }
            /* 각 단계 */
            .step {
                display: flex;
                flex-direction: column;
                align-items: center;
                position: relative;
            }

            /* 시간 */
            .step .time {
                font-size: 12px;
                color: #aaa;
                margin-bottom: 4px;
                min-height: 16px; /* 최소 높이 확보 */
                line-height: 16px; /* 빈 경우에도 공간 유지 */
            }

            /* 원형 표시 */
            .step .circle {
                width: 14px;
                height: 14px;
                border-radius: 50%;
                border: 2px solid #555;
                background: #111;
                position: relative;
            }

            /* 완료된 단계 (초록색) */
            .step.done .circle {
                background: #00c853;
                border-color: #00c853;
            }

            /* 현재 단계 (흰색) */
            .step.active .circle {
                background: #fff;
                border-color: #fff;
            }

            /* 텍스트 라벨 */
            .step .label {
                font-size: 13px;
                margin-top: 4px;
                color: #ddd;
            }

            /* 연결선 */
            .step:not(:last-child)::after {
                content: '';
                position: absolute;
                top: 21px;
                left: 50%;
                width: 100%;
                height: 2px;
                background: #555;
                z-index: -1;
            }

            /* 완료된 구간 선 */
            .step.done:not(:last-child)::after {
                background: #00c853;
            }

            .sidebar-bottom {
                width: 100%;
                flex: 8;
                border: 1px solid blueviolet;
                padding: 10px;
            }
            .bottom-main {
                width: 100%;
                height: 100%;
                border: 1px solid black;
            }

            /* 각 섹션 (금액/연락처/주소/메모) */
            .delivery_detail {
                padding: 15px;
                /* min-height: 490px;
                max-height: 700px; */
                height: 100%;
                border-radius: 10px;
                background: #222; /* 다크 배경 */
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.6);
                color: #fff;
            }
            .delivery_title {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin: 12px 0;
                font-size: 14px;
            }
            .delivery_title span {
                font-weight: 600;
                color: #fff;
            }

            /* input, textarea */
            .custom-h-input {
                color: #eee;
                border: none;
                background: transparent;
                text-align: right;
                margin-right: 10px;
                width: 100%;
                pointer-events: none; /* 읽기전용 */
            }
            #delivery_address,
            #shop_address {
                padding: 6px 10px;
                width: 100%;
                text-align: right;
                max-width: 250px;
                font-size: 14px;
                line-height: 1.5;
                border-radius: 6px;
                background: rgba(0, 0, 0, 0);
                color: #fff;
                overflow-wrap: break-word; /* 긴 주소 줄바꿈 */
                white-space: pre-wrap; /* 줄바꿈 유지 */
            }

            /* 고객 메모 */
            .delivery_title.flex-column {
                flex-direction: column;
                align-items: flex-start;
            }
            .delivery_title.flex-column span {
                margin-bottom: 6px;
            }
            .delivery_title.flex-column .card {
                width: 100%;
                padding: 8px;
                background: #2a2a2a;
                color: #fff;
            }

            .order-box {
                background-color: #111; /* 아주 어두운 배경 */
                color: #fff; /* 글씨 흰색 */
                padding: 12px 16px;
                border-radius: 12px;
                word-break: break-word;
                font-size: 14px;
                line-height: 1.6;

                overflow-y: auto;
                margin-top: 6px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
                width: 100%;
                max-height: 90px;
                overflow-y: auto;
                scrollbar-gutter: stable;
            }

            /* 부모 div */
            .delivery_title.flex-column > div {
                width: 100%;
            }
            .delivery_title > div {
                height: auto;
            }

            /* 주문 항목 */
            .order-box p {
                margin: 0 0 6px 0;
                padding-left: 8px;
                font-size: 14px;
                position: relative;
            }
            .order-box p:before {
                content: '•';
                position: absolute;
                left: 0;
                color: #ffcd39; /* 노란 포인트 */
                font-size: 14px;
            }
            .order-box p:last-child {
                margin-bottom: 0;
            }

            /* 스크롤바 */
            .order-box::-webkit-scrollbar {
                width: 10px;
            }
            .order-box::-webkit-scrollbar-thumb {
                background: #555;
                border-radius: 12px;
            }
            .order-box::-webkit-scrollbar-track {
                background: #222;
                border-radius: 12px;
            }

            /* 메인 영역 (메인 헤더 + 메인 컨텐츠)*/
            .wrapper-main {
                min-width: 700px;
                flex: 7.5;
                height: 100%;
                border: 1px solid orange;
                display: flex;
                flex-direction: column;
            }

            /* 메인 헤더 영역 */
            .main-header {
                flex: 2;
                width: 100%;
                border: 2px solid purple;
                display: flex;
                flex-direction: column;
            }

            .header-top {
                display: flex;
                justify-content: space-between;
                flex: 4;
                border: 1px solid red;
                padding: 10px;
            }
            .header-bottom {
                flex: 6;
                border: 1px solid silver;
                display: flex;
                justify-content: space-between;
                align-items: flex-end;
                padding: 0px 10px;
            }
            .navbar {
                padding-bottom: 0;
            }
            .nav-link {
                width: 100px;
                font-size: 1.3em;
                text-align: center;
                color: #000000;
            }
            .nav-link .active {
            }
            .nav-link:hover {
                background-color: #acabab;
                color: blue;
            }

            .top_scroll_btn:hover,
            .page_load:hover {
                background: #e55a25;
            }

            .main-content {
                flex: 8;
                overflow-y: scroll;
                overflow-x: hidden;
                padding: 10px;
                position: relative;
                border-top: 1px solid #ccc;
            }

            /* =============================== */
            /* Floating Button (고정 버튼)     */
            /* =============================== */

            .floating-btn {
                position: fixed;
                bottom: 25px;
                z-index: 5000;

                /* 기본 버튼 스타일 */
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .page_load,
            .top_scroll_btn {
                width: 45px;
                height: 45px;
                background: #ff6b35;
                color: #fff;
                border-radius: 10px;

                display: flex;
                justify-content: center;
                align-items: center;

                cursor: pointer;
                font-size: 18px;
                font-weight: bold;

                box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
                transition: background 0.2s ease;
            }

            .top_scroll_btn {
                display: none;
            }

            .page_load:hover,
            .top_scroll_btn:hover {
                background: #e55a25;
            }
        </style>
    </head>
    <body>
        <div class="layout-wrapper">
            <!-- 사이드바 영역-->
            <aside class="wrapper-sidebar">
                <!-- 사이드바 상단 영역-->
                <div class="sidebar-top">
                    <div class="top-timezone">
                        <span class="timezone">
                            <span class="timezone_hour">11</span>
                            :
                            <span class="timezone_min">20</span>
                            :
                            <span class="timezone_sec">30</span>
                        </span>
                    </div>
                    <div class="top-delivery-info card">
                        <div class="step requested done">
                            <div class="time">14:00</div>
                            <div class="circle"></div>
                            <div class="label">요청</div>
                        </div>
                        <div class="step assigned active">
                            <div class="time">15:30</div>
                            <div class="circle"></div>
                            <div class="label">배차</div>
                        </div>
                        <div class="step pickup">
                            <div class="time"></div>
                            <div class="circle"></div>
                            <div class="label">픽업</div>
                        </div>
                        <div class="step">
                            <div class="time"></div>
                            <div class="circle"></div>
                            <div class="label">완료</div>
                        </div>
                    </div>
                </div>
                <!-- 사이드바 하단 영역 -->
                <div layout:fragment="sidebar-bottom"></div>
            </aside>

            <!-- 메인 영역 -->
            <main class="wrapper-main">
                <!-- 메인 상단 영역 -->
                <div th:replace="~{rider/fragment_mainHeader :: main-header}"></div>
                <!-- 메인 컨텐츠 영역-->
                <section class="main-content" id="mainContent">
                    <th:block layout:fragment="content"></th:block>
                </section>
                <div class="floating-btn">
                    <div class="page_load"><i class="bi bi-arrow-clockwise"></i></div>
                    <div class="top_scroll_btn">↑</div>
                </div>
            </main>
        </div>

        <script th:src="@{/js/rider/riderScroll.js}"></script>
        <script th:inline="javascript">
            // 모든 jQuery AJAX 요청에 CSRF 헤더 자동 첨부
            $(function () {
                const token = $('meta[name="_csrf"]').attr('content');
                const header = $('meta[name="_csrf_header"]').attr('content');
                $(document).ajaxSend(function (e, xhr) {
                    if (token && header) xhr.setRequestHeader(header, token);
                });
            });

            // 상단 timezone js 코드
            $(function () {
                function tickOne($box) {
                    const tz = $box.data('tz') || Intl.DateTimeFormat().resolvedOptions().timeZone;
                    const fmt = new Intl.DateTimeFormat('ko-KR', {
                        timeZone: tz,
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                    });
                    const parts = fmt.formatToParts(new Date());
                    const map = {};
                    parts.forEach((p) => (map[p.type] = p.value));

                    $box.find('.timezone_hour').text(map.hour);
                    $box.find('.timezone_min').text(map.minute);
                    $box.find('.timezone_sec').text(map.second);
                }

                function tickAll() {
                    $('.timezone').each(function () {
                        tickOne($(this));
                    });
                }

                tickAll(); // 즉시 1회
                setInterval(tickAll, 1000); // 1초마다 갱신

                // 메인 헤더 navbar active 코드
                const pathname = window.location.pathname;
                switchNav();
                function switchNav() {
                    const nav_link = $('.nav-link');
                    nav_link.removeClass('active');
                    switch (pathname) {
                        case '/rider/':
                            nav_link.eq(0).addClass('active');
                            break;
                        case '/rider/all':
                            break;
                        case '/rider/complete':
                            break;
                        case '/rider/myInfo':
                            nav_link.eq(5).addClass('active');
                            break;
                        default:
                            break;
                    }
                }
            });

            // 페이지 스크롤 이벤트
            $(document).ready(function () {
                const $scrollBtn = $('.top_scroll_btn'); // "맨 위로" 버튼 선택
                const $contentMain = $('.main-content'); // 스크롤 영역 선택
                const $pageLoad = $('.page_load'); // 새로고침 버튼
                // 스크롤 이벤트 감지
                $contentMain.on('scroll', function () {
                    // content_main 영역을 200px 이상 스크롤하면 버튼 보이기
                    let scrollHeight = $contentMain[0].scrollHeight; // 전체 높이
                    let clientHeight = $contentMain[0].clientHeight; // 보이는 높이
                    let scrollTop = $contentMain.scrollTop(); // 현재 스크롤 위치
                    // console.log('scrollHeight:', scrollHeight);
                    // console.log('clientHeight:', clientHeight);
                    // console.log('scrollTop:', scrollTop);
                    // console.log('최대 스크롤 가능:', scrollHeight - clientHeight);
                    if ($contentMain.scrollTop() > 150) {
                        $scrollBtn.css('display', 'flex'); // 버튼 표시
                    } else {
                        $scrollBtn.hide(); // 버튼 숨김
                    }
                });

                // 버튼 클릭 시 content_main 맨 위로 부드럽게 이동
                $scrollBtn.on('click', function () {
                    $contentMain.animate({ scrollTop: 0 }, 0);
                    // 400ms 동안 스무스하게 맨 위로 스크롤
                });

                $pageLoad.on('click', function () {
                    location.reload();
                });
            });

            function updateFloatingPosition() {
                const main = document.getElementById('mainContent');
                const btn = document.querySelector('.floating-btn');

                const rect = main.getBoundingClientRect();

                // main-content 오른쪽 끝 기준으로 버튼 위치를 계산
                btn.style.right = window.innerWidth - rect.right + 30 + 'px';
                // bottom 위치 계산 (컨텐츠 내부 상대 위치)
                btn.style.bottom = window.innerHeight - rect.bottom + 20 + 'px';
            }

            window.addEventListener('resize', updateFloatingPosition);
            window.addEventListener('load', updateFloatingPosition);
            updateFloatingPosition();

            // 로그아웃
            $('#logoutBtn').on('click', function () {
                $.ajax({
                    url: '/rider/logout',
                    type: 'POST',
                    success: function () {
                        window.location.href = '/rider/login';
                    },
                });
            });
        </script>
    </body>
</html>
