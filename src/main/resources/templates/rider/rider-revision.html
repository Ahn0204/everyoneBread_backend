<!--
******************************************
*  Created On : 2025. 11. 14.
*  File : rider-register.html
*******************************************
 -->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="_csrf" th:content="${_csrf.token}" />
        <meta name="_csrf_header" th:content="${_csrf.headerName}" />
        <script src="https://code.jquery.com/jquery-latest.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
        <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
        <style>
            /* 모달 관련 css */

            /*  모달 뒷배경  */
            .dimmed {
                position: fixed;
                inset: 0; /* top, right, bottom, left 0 */
                background: rgba(0, 0, 0, 0.7);
                z-index: 1000;
                display: none; /* JS로 제어 */
            }

            .modal-layer {
                position: fixed;
                top: 50%;
                left: 50%;
                width: 600px;
                height: 600px;
                background: #fff;

                transform: translate(-50%, -50%); /* 화면 정중앙 배치 */
                border-radius: 10px;
                display: none; /* 모달 기본 숨김 */
                z-index: 1001; /* dimmed 위로 */
                overflow: hidden; /* 내용 넘침 방지 */
            }

            .modal {
                width: 100%;
                height: 100%;

                display: flex;
                flex-direction: column;

                background: #fff;
            }

            .modal-top {
                display: flex;
                align-items: center;
                justify-content: space-between;

                height: 60px;
                padding: 0 20px;

                background: #f5f5f5;
                border-bottom: 1px solid #e0e0e0;
            }

            .modal-top h2 {
                margin: 0;
                font-size: 18px;
                font-weight: 600;
                color: #333;
            }

            .closeBtn {
                font-size: 28px;
                font-weight: 500;
                cursor: pointer;
                user-select: none;
                color: #555;
                transition: 0.2s;
            }

            .closeBtn:hover {
                color: #000;
            }

            .modal-content {
                flex: 1; /* 남은 모든 공간을 차지 */
                padding: 20px; /* 여백 */
                overflow-y: auto; /* 내용 많을 때 스크롤 */
                background: #fff; /* 배경색 */
                box-sizing: border-box; /* 패딩 포함한 안정적 레이아웃 */
                border-radius: 0;
            }

            .modal-bottom {
                height: 60px; /* 고정 높이 */
                padding: 0 20px;

                display: flex;
                align-items: center; /* 버튼들을 수직 중앙 정렬 */
                justify-content: flex-end; /* 오른쪽 정렬 */
                gap: 10px; /* 버튼 간 간격 */

                background: #f8f8f8;
                border-top: 1px solid #e0e0e0;
                box-sizing: border-box;
            }

            .modal-btn {
                padding: 8px 16px;
                border-radius: 6px;
                background: #e3e3e3;
                color: #333;
                font-size: 14px;
                text-decoration: none;
                cursor: pointer;
                transition: background 0.2s;
            }

            .modal-btn:hover {
                background: #d0d0d0;
            }

            .imgBtn {
                height: 30px;
                line-height: 15px;
                margin-bottom: 10px;
            }
        </style>
        <style>
            /*Fake Input*/
            .filebox {
                display: flex;
                align-items: center;
                width: 100%;
                height: 30px;
                border: 1px solid #ddd;
                border-radius: 6px;
                background: #f1f3f5;
                overflow: hidden;
            }

            .upload-btn {
                background: #fff;
                padding: 10px 16px;
                border-right: 1px solid #ddd;
                cursor: pointer;
                font-size: 15px;
                white-space: nowrap;
            }

            .upload-btn:hover {
                background: #f8f9fa;
            }

            .upload-name {
                padding: 10px 15px;
                font-size: 15px;
                color: #333;
                flex: 1;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        </style>
        <title>모두의 빵</title>
    </head>
    <body>
        <div class="container" style="width: 600px; height: 80vh">
            <h5 class="my-4 border-bottom">라이더 서류 보완</h5>
            <form th:object="${riderRegisterForm}" th:action="@{/rider/revision-request}" id="form" method="post" enctype="multipart/form-data">
                <!-- <th:block th:if="${#fields.hasAnyErrors()}"></th:block>
                <div class="alert alert-danger" role="alert" th:if="${#fields.hasAnyErrors()}">
                    <div style="height: 80px; width: 100%" th:each="error , loop : ${#fields.allErrors()}" th:text="${error}+${loop.count}"></div>
                </div> -->
                <input type="hidden" th:value="${rider.licenseFile}" id="beforeFile" />
                <div class="mb-3 form-floating">
                    <input type="text" maxlength="15" id="driverLicense" th:field="*{driverLicense}" class="form-control" placeholder="운전면허번호" />
                    <label for="driverLicense" class="form-label">운전면허번호</label>
                </div>
                <div class="mb-3 form-floating d-flex">
                    <div>
                        <label for="licenseCreatedAt">면허 발급일자</label>
                    </div>
                    <div>
                        <!-- <input type="date" name="licenseCreatedAt" id="licenseCreatedAt" /> -->
                        <input type="text" id="licenseCreatedAt" th:field="*{licenseCreatedAt}" placeholder="면허 발급일자 선택" />
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <label for="formFileSm" class="form-label">면허증 사진</label>
                        <button type="button" id="" class="btn btn-secondary openUpload imgBtn">사진 추가</button>
                    </div>
                    <!-- <p class="previewImg" style="font-size: 12px; margin-bottom: 0; margin-top: 10px; color: #001eff; cursor: pointer">미리보기</p> -->
                    <div class="filebox">
                        <label class="openUpload upload-btn">파일 선택</label>
                        <span id="fileName" class="upload-name">선택된 파일 없음</span>
                        <input type="file" id="realFile" th:field="*{licenseFile}" accept="image/*" hidden />
                    </div>
                </div>

                <div class="mb-3 d-flex justify-content-end">
                    <button type="button" id="backBtn" class="btn btn-primary mx-3">뒤로</button>
                    <button type="submit" id="ckInput" class="btn btn-primary">서류 제출</button>
                </div>
            </form>
            <!-- 모달 뒷배경 -->
            <div class="dimmed" aria-hidden="true" id="dimmed" style="display: none"></div>
            <!-- 모달 배경 -->
            <div id="previewModal" class="modal-layer" style="display: none">
                <div class="modal">
                    <div class="modal-top">
                        <h2>사진 업로드</h2>
                        <span class="closeBtn">&times;</span>
                    </div>
                    <div class="modal-content">
                        <div class="filebox">
                            <label for="realFile" class="upload-btn">파일 선택</label>
                            <span id="fileName" class="upload-name">선택된 파일 없음</span>
                        </div>
                        <img id="previewContent" src="" alt="이미지 미리보기" style="display: none; margin-top: 10px; height: 90%" />
                    </div>
                    <div class="modal-bottom">
                        <a href="javascript:;" class="modal-btn closeBottomBtn"><span class="btn_text">취소</span></a>
                        <a href="javascript:;" class="modal-btn successBottomBtn"><span class="btn_text">확인</span></a>
                    </div>
                </div>
            </div>
            <script th:inline="javascript">
                // 모든 jQuery AJAX 요청에 CSRF 헤더 자동 첨부
                $(function () {
                    const token = $('meta[name="_csrf"]').attr('content');
                    const header = $('meta[name="_csrf_header"]').attr('content');
                    $(document).ajaxSend(function (e, xhr) {
                        if (token && header) xhr.setRequestHeader(header, token);
                    });
                });

                flatpickr.localize(flatpickr.l10ns.ko);

                flatpickr('#licenseCreatedAt', {
                    dateFormat: 'Y-m-d',
                    maxDate: 'today',
                    allowInput: true,
                    locale: 'ko',
                });

                //=========== 운전 면허 번호 ===========
                // 운전면허번호 - 달아주기
                function formatDriverLicense(value) {
                    // 숫자만 추출하고 최대 12자리까지만 허용
                    const digits = value.replace(/\D/g, '').slice(0, 12);

                    const part1 = digits.slice(0, 2); // 지역코드
                    const part2 = digits.slice(2, 4); // 발급년도
                    const part3 = digits.slice(4, 10); // 일련번호
                    const part4 = digits.slice(10, 12); // 검증번호

                    let result = part1;
                    if (part2) result += '-' + part2;
                    if (part3) result += '-' + part3;
                    if (part4) result += '-' + part4;

                    return result;
                }

                // 타이핑할 때 화면에만 하이픈 표시
                $('#driverLicense').on('input', function () {
                    // 현재 요소의 값이 15자가 넘을 경우 focus 빼기
                    if (this.value.length >= 15) {
                        this.blur();
                    }
                    const raw = this.value.replace(/\D/g, '').slice(0, 12); // 숫자만, 최대 12자리
                    this.value = formatDriverLicense(raw);
                });
                //===================================

                //=========== 모달 관련 JS ===========
                const dimmed = $('#dimmed'); // 모달 뒷 배경
                const previewModal = $('#previewModal'); // 실제 사용할 모달
                const cTB = $('.closeBtn'); // 상단 닫기 버튼
                const cBB = $('.closeBottomBtn'); // 하단 닫기 버튼
                const sBB = $('.successBottomBtn'); // 하단 확인 버튼

                // 모달 닫기 (X 클릭)
                cTB.on('click', function () {
                    previewModal.css('display', 'none');
                    dimmed.css('display', 'none');
                    $('.upload-name').text('선택된 파일 없음');
                    $('#realFile').val('');
                });
                cBB.on('click', function () {
                    previewModal.css('display', 'none');
                    dimmed.css('display', 'none');
                    $('.upload-name').text('선택된 파일 없음');
                    $('#realFile').val('');
                });
                sBB.on('click', function () {
                    previewModal.css('display', 'none');
                    dimmed.css('display', 'none');
                });

                // 바깥 영역 클릭 시 닫기
                $(window).on('click', function (e) {
                    // e.target이 모달 배경(#previewModal)과 같은 경우만 닫기
                    if (e.target.id === 'dimmed') {
                        previewModal.css('display', 'none');
                        dimmed.css('display', 'none');
                        $('.upload-name').text('선택된 파일 없음');
                        $('#realFile').val('');
                    }
                });

                // 파일 업로드 및 미리보기 모달
                $('.openUpload').on('click', function () {
                    dimmed.show();
                    previewModal.show();
                });

                $('#realFile').on('change', function () {
                    const file = $('#realFile')[0].files[0]; // 선택된 파일 (첫 번째)
                    $('#previewContent').hide();
                    // 선택된 파일이 없을경우
                    if (!file) {
                        alert('업로드 된 파일이 없습니다.');
                        $('.upload-name').text('선택된 파일 없음');
                        return;
                    }
                    // image 파일이 아닌 경우
                    if (!file.type.startsWith('image/')) {
                        $('.upload-name').text('선택된 파일 없음');
                        $(this).val(''); // input file 초기화
                        alert('이미지 파일이 아닙니다.');
                        return;
                    }

                    const filename = this.files[0].name;
                    const reader = new FileReader();
                    console.log(filename);
                    reader.onload = function (e) {
                        $('#previewContent').attr('src', e.target.result); // base64 데이터 URL
                        $('#previewContent').show();
                        $('.upload-name').text(filename);
                        console.log(e.target.result);
                    };
                    reader.readAsDataURL(file);
                });

                //===================================
            </script>
        </div>
    </body>
</html>
