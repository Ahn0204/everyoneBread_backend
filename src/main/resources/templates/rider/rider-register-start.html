<!--
******************************************
*  Created On : 2025. 11. 22.
*  File : rider-register-start.html
*******************************************
 -->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="_csrf" th:content="${_csrf.token}" />
        <meta name="_csrf_header" th:content="${_csrf.headerName}" />
        <!-- JQuery CDN -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

        <!-- SweetAlert2 CDN -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <!-- BootStrap CDN -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" />
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
        <script th:src="@{/js/comm/sweetalert.noah.js}"></script>
        <style>
            /* 1. 기본 초기화 및 폰트 */
            * {
                box-sizing: border-box;
                font-family: 'Noto Sans KR', sans-serif;
            }

            body {
                margin: 0;
                padding: 40px 0;
                background-color: #fff;
                display: flex;
                justify-content: center;
                min-height: 100vh;
            }

            /* 2. 전체 컨테이너 (박스 형태) */
            .signup-container {
                width: 100%;
                max-width: 550px; /* 로그인보다 조금 더 넓게 */
                padding: 40px;
                border: 2px solid #000; /* 외곽 테두리 (와이어프레임 느낌) */
                border-radius: 10px;
                background-color: #fff;
            }

            /* 3. 헤더 스타일 */
            .signup-header {
                text-align: center;
                margin-bottom: 30px;
            }
            .signup-header h1 {
                font-size: 32px;
                font-weight: 700;
                margin: 0 0 20px 0;
            }
            .signup-header hr {
                border: 0;
                height: 2px;
            }

            /* 4. 입력 폼 행(Row) 스타일 */
            .form-row {
                display: flex;
                align-items: center;
                margin-bottom: 15px;
            }

            /* 왼쪽 라벨 (아이디, 비밀번호 등) */
            .form-label {
                width: 120px; /* 고정 너비로 정렬 */
                font-weight: 700;
                font-size: 15px;
                color: #333;
                flex-shrink: 0; /* 줄어들지 않음 */
            }

            /* 입력창 공통 스타일 */
            .input-text {
                flex: 1; /* 남은 공간 채움 */
                height: 45px;
                padding: 0 10px;
                border: 1px solid #000;
                border-radius: 4px;
                font-size: 14px;
                outline: none;
            }
            .input-text:focus {
                background-color: #f9f9f9;
                border-width: 2px;
            }

            /* 5. 특수 입력 영역 (주민번호, 버튼 포함) */

            /* 버튼이 옆에 붙는 경우 */
            .input-with-btn {
                display: flex;
                flex: 1;
                gap: 8px; /* 입력창과 버튼 사이 간격 */
            }

            /* 중복확인, 인증 버튼 등 작은 버튼 */
            .btn-small {
                height: 45px;
                padding: 0 15px;
                background-color: #fff;
                border: 1px solid #000;
                border-radius: 4px;
                cursor: pointer;
                font-size: 13px;
                font-weight: bold;
                white-space: nowrap; /* 줄바꿈 방지 */
                transition: all 0.2s;
            }
            .btn-small:hover {
                background-color: #f0f0f0;
            }

            /* 주민번호 영역 */
            .jumin-area {
                display: flex;
                flex: 1;
                align-items: center;
                gap: 8px;
            }
            .input-jumin {
                width: 100%;
                height: 45px;
                padding: 0 10px;
                border: 1px solid #000;
                border-radius: 4px;
                text-align: center;
            }

            /* 6. 하단 버튼 영역 (가입, 다음) */
            .action-buttons {
                margin-top: 40px;
                display: flex;
                flex-direction: column;
                gap: 15px;
                align-items: center;
            }

            .btn-large {
                width: 200px;
                height: 50px;
                font-size: 16px;
                font-weight: 700;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s;
            }

            /* 가입 버튼 (메인) */
            .btn-submit {
                background-color: #fff;
                border: 2px solid #000;
                color: #000;
            }
            .btn-submit:hover {
                background-color: #000;
                color: #fff;
            }

            /* 다음 버튼 (판매자용) */
            .btn-next {
                background-color: #000;
                border: 2px solid #000;
                color: #fff;
                color: #6495ed;
            }
            .btn-next:hover {
                opacity: 0.8;
            }

            /* 인증번호 입력 행 (라벨 없음) */
            .auth-code-row {
                padding-left: 120px; /* 라벨 너비만큼 들여쓰기 */
            }

            .mask-container {
                position: relative;
            }

            .mask-input {
                font-family: monospace;
                letter-spacing: 3px;
            }

            /* 마스킹 배경 레이어 */
            .mask-fixed {
                position: absolute;
                top: 63%;
                left: 26px; /* 첫 글자 뒤에 위치하도록 조정 */
                transform: translateY(-50%);
                color: #999;
                pointer-events: none;
                font-family: monospace;
                letter-spacing: 3px;
            }

            /* 중복검사 피드백 text*/
            /* 사용 가능할 때*/
            .feedback-t {
                color: rgb(0, 255, 0);
            }
            /* 사용 불가능 할 때*/
            .feedback-f {
                color: rgb(255, 0, 0);
            }
            .bi-person {
                font-size: 14px;
                pointer-events: none; /* 클릭, 포커스 등 모든 이벤트 차단 */
            }

            .end-20 {
                right: 20% !important;
            }

            #emailSuggest .list-group-item {
                cursor: pointer;
            }
            #emailSuggest .list-group-item:hover {
                background-color: #f0f0f0;
            }
        </style>
    </head>
    <body>
        <div class="signup-container">
            <div class="signup-header">
                <h1>회원가입</h1>
                <hr />
            </div>

            <form method="post" th:action="@{/rider/register/start}" th:object="${memberRegisterForm}">
                <th:block th:if="${#fields.hasAnyErrors()}">
                    <script th:inline="javascript">
                        const errorText = /*[[${#fields.errors()}]]*/ '';
                        console.log(errorText);
                        const errorArr = ['아이디', '비밀번호', '이름', '주민', '이메일', '휴대폰번호', '주소'];
                        outer: for (var i = 0; i < errorArr.length; i++) {
                            for (var j = 0; j < errorText.length; j++) {
                                if (errorText[j].includes(errorArr[i])) {
                                    console.log('i : ' + i);
                                    console.log('j : ' + j);
                                    console.log(inputs);
                                    showErrorAlert(errorText[j]);
                                    break outer;
                                }
                            }
                        }
                    </script>
                </th:block>

                <div class="mb-3 form-floating">
                    <input type="text" maxlength="15" id="memberId" th:field="*{memberId}" class="form-control" placeholder="아이디" />
                    <label for="memberId" class="form-label">아이디</label>
                    <i class="bi bi-person position-absolute top-50 end-0 translate-middle-y me-3">아이디 중복여부</i>
                </div>
                <div class="mb-3 form-floating">
                    <input type="text" maxlength="15" id="memberPw" th:field="*{memberPw}" class="form-control" placeholder="비밀번호" />
                    <label for="memberPw" class="form-label">비밀번호</label>
                    <i class="bi bi-person position-absolute top-50 end-0 translate-middle-y me-3">비밀번호 중복여부</i>
                </div>
                <div class="mb-3 form-floating">
                    <input type="text" maxlength="15" id="memberPwRe" th:field="*{memberPwRe}" class="form-control" placeholder="비밀번호 확인" />
                    <label for="memberPwRe" class="form-label">비밀번호 확인</label>
                    <i class="bi bi-person position-absolute top-50 end-0 translate-middle-y me-3">비밀번호 확인 중복여부</i>
                </div>

                <div class="mb-3 form-floating">
                    <input type="text" id="memberName" th:field="*{memberName}" class="form-control" placeholder="이름" />
                    <label for="memberName" class="form-label">이름</label>
                </div>
                <div class="mb-3 d-flex">
                    <div class="form-floating">
                        <input type="text" maxlength="6" id="memberJuminFront" th:field="*{memberJuminFront}" class="form-control" placeholder="주민등록번호" />
                        <label for="memberJuminFront" class="form-label">주민등록번호</label>
                    </div>
                    <span class="d-flex" style="align-items: center; margin: 0px 10px">-</span>
                    <div class="form-floating mask-container">
                        <input type="text" maxlength="1" id="memberJuminBack" th:field="*{memberJuminBack}" class="form-control mask-input" placeholder="뒷자리" />
                        <label for="memberJuminBack" class="form-label"></label>
                        <!-- 마스킹 표시용 가짜 레이어 -->
                        <span class="mask-fixed">******</span>
                    </div>
                </div>
                <div class="mb-3 form-floating position-relative">
                    <input type="email" id="memberEmail" th:field="*{memberEmail}" class="form-control" placeholder="운전면허번호" />
                    <label for="memberEmail" class="form-label">이메일</label>
                    <ul id="emailSuggest" class="list-group position-absolute w-100" style="top: 70px; display: none; z-index: 1000; background-color: red"></ul>
                    <i class="bi bi-person position-absolute top-50 end-0 translate-middle-y me-3">이메일 중복여부</i>
                </div>
                <div class="mb-3">
                    <div class="form-floating d-flex">
                        <input type="text" id="memberPhone" th:field="*{memberPhone}" class="form-control" placeholder="휴대폰" />
                        <label for="memberPhone" class="form-label">휴대폰</label>
                        <button type="button" id="authCodeSend" class="btn" style="border: 1px solid black; width: 20%; margin-left: 10px">인증</button>
                        <i class="bi bi-person position-absolute top-50 end-20 translate-middle-y me-3" id="resendAuth"></i>
                    </div>
                </div>
                <div class="phoneArea" style="display: none">
                    <div class="mb-3 form-floating d-flex">
                        <input type="text" id="authCode" th:field="*{authCode}" class="form-control" placeholder="인증번호" />
                        <label for="authCode" class="form-label">인증번호</label>
                        <button type="button" id="authCodeChk" class="btn" style="border: 1px solid black; width: 20%; margin-left: 10px">확인</button>
                        <i class="bi bi-person position-absolute top-50 end-20 translate-middle-y me-3" id="authCodeTime"></i>
                    </div>
                </div>
                <div class="mb-3 form-floating">
                    <input type="text" id="memberAddress" th:field="*{roadAddress}" class="form-control" placeholder="주소" />
                    <label for="memberAddress" class="form-label">주소</label>
                </div>
                <div class="mb-3 form-floating">
                    <input type="text" id="addressDetail" th:field="*{DetailAddress}" class="form-control" placeholder="상세 주소" />
                    <label for="addressDetail" class="form-label">상세주소</label>
                </div>

                <div class="d-flex justify-content-center gap-5">
                    <button type="button" class="btn btn-secondary">뒤로</button>
                    <button type="submit" class="btn btn-secondary" id="nextPage">다음</button>
                </div>
            </form>
        </div>
        <script th:inline="javascript">
            // 모든 jQuery AJAX 요청에 CSRF 헤더 자동 첨부
            $(function () {
                const token = $('meta[name="_csrf"]').attr('content');
                const header = $('meta[name="_csrf_header"]').attr('content');
                $(document).ajaxSend(function (e, xhr) {
                    if (token && header) xhr.setRequestHeader(header, token);
                });
            });

            // 중복/유효성 검사시 피드백 내용 출력 CSS 컨트롤 함수
            function feedback(element, boolean) {
                if (boolean) {
                    element.removeClass('feedback-f');
                    element.addClass('feedback-t');
                    element.removeClass('d-none');
                } else {
                    element.removeClass('feedback-t');
                    element.addClass('feedback-f');
                    element.removeClass('d-none');
                }
            }
            // 아이디 유효성 검사
            $('#memberId').on('change', function () {
                const $this = $(this);
                const $i = $this.siblings('i');
                // const $i = $this.next().next();
                // $this.next().next().text('123');
                if (!$this.val()) {
                    $i.text('');
                } else {
                    // ajax 로 아이디 중복 확인
                    $.ajax({
                        url: '/rider/ajaxDuplicationId',
                        type: 'POST',
                        data: { memberId: $this.val() },
                        success: function (response) {
                            if (response != true) {
                                // 성공시
                                $i.text('사용 가능한 아이디 입니다.');
                                feedback($i, true);
                            } else {
                                // 실패시
                                $i.text('중복된 아이디 입니다.');
                                feedback($i, false);
                            }
                        },
                        error: function (xhr, status, message) {},
                    });
                }
            });

            // 비밀번호 유효성 검사
            $('#memberPw').on('change', function () {});
            // 비밀번호 확인 유효성 검사
            $('#memberPwRe').on('change', function () {});

            // 주민등록번호
            $('#memberJuminFront').on('change', function () {});
            $('#memberJuminBack').on('change', function () {});

            // 이메일
            $('#memberEmail').on('change', function () {
                const $this = $(this);
                const $i = $this.siblings('i');
                // const $i = $this.next().next();
                // $this.next().next().text('123');
                if ($this.val()) {
                    // ajax 로 아이디 중복 확인
                    $.ajax({
                        url: '/rider/ajaxDuplicationEmail',
                        type: 'POST',
                        data: { memberEmail: $this.val() },
                        success: function (response) {
                            if (response != true) {
                                // 성공시
                                $i.text('사용 가능한 이메일 입니다.');
                                feedback($i, true);
                            } else {
                                // 실패시
                                $i.text('이미 사용중인 이메일 입니다.');
                                feedback($i, false);
                            }
                        },
                        error: function (xhr, status, message) {},
                    });
                } else {
                    $i.text('');
                }
            });
            const emailDomains = ['gmail.com', 'naver.com', 'daum.net', 'kakao.com', 'nate.com'];

            let selectedIndex = -1; // 현재 선택된 리스트 index

            $('#memberEmail').on('input', function () {
                const val = $(this).val();
                const suggestList = $('#emailSuggest');

                if (!val.includes('@')) {
                    suggestList.hide();
                    selectedIndex = -1;
                    return;
                }

                const [local, domain] = val.split('@');

                const filtered = domain ? emailDomains.filter((d) => d.startsWith(domain)) : emailDomains;

                suggestList.empty();
                selectedIndex = -1;

                filtered.forEach((d, i) => {
                    suggestList.append(`
                <li class="list-group-item email-option" data-index="${i}">
                    ${local}@${d}
                </li>
            `);
                });

                suggestList.show();
            });

            // 리스트 클릭 → 이메일 입력
            $(document).on('click', '.email-option', function () {
                $('#memberEmail').val($(this).text());
                $('#emailSuggest').hide();
            });

            // 키보드 조작 (↑↓, Enter)
            $('#memberEmail').on('keydown', function (e) {
                const items = $('#emailSuggest .email-option');

                if (items.length === 0) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex++;
                    if (selectedIndex >= items.length) selectedIndex = 0;
                    updateActive(items);
                }

                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex--;
                    if (selectedIndex < 0) selectedIndex = items.length - 1;
                    updateActive(items);
                }

                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedIndex >= 0 && selectedIndex < items.length) {
                        $('#memberEmail').val($(items[selectedIndex]).text());
                        $('#emailSuggest').hide();
                    }
                }
            });

            // active 표시 갱신
            function updateActive(items) {
                items.removeClass('active');
                $(items[selectedIndex]).addClass('active');
            }

            // blur 후 자동 숨김 (UX)
            $('#memberEmail').on('blur', function () {
                setTimeout(() => $('#emailSuggest').hide(), 150);
            });

            // 전화번호 - 달아주기
            function formatKrPhone(digits) {
                if (!digits) return '';
                // 일반(010/0XX) 규칙
                if (digits.length <= 3) return digits;
                if (digits.length <= 7) return digits.replace(/^(\d{3})(\d{0,4})$/, '$1-$2'); // 010-XXXX
                if (digits.length <= 11) return digits.replace(/^(\d{3})(\d{3,4})(\d{0,4})$/, '$1-$2-$3'); // 010-XXX(X)-XXXX
                return digits.slice(0, 11).replace(/^(\d{3})(\d{4})(\d{4})$/, '$1-$2-$3'); // 최대 11자리
            }

            // 휴대전화 번호
            $('#memberPhone').on('input', function () {
                const raw = this.value.replace(/\D/g, '').slice(0, 11); // 숫자만, 최대 11자리
                this.value = formatKrPhone(raw);
            });

            // 인증번호 관련
            let resendAuthResult = true; // 재전송가능 여부
            let authIntervalId; // setInterval ID명
            let resendAuthIntervalId; // setInterval ID명

            // 인증번호 전송 버튼 클릭
            $('#authCodeSend').on('click', function () {
                // 입력한 휴대전화 번호가 숫자 11자리 일 경우에만 실행
                if ($('#memberPhone').val().replace(/\D/g, '').length == 11) {
                    if (resendAuthResult == true) {
                        resendAuthResult = false;
                        authCode();
                        resendCode();
                    } else {
                    }
                } else {
                    focusAlert('error', '실패', '전화번호를 확인해주세요', $('#memberPhone'));
                }
            });
            function resendCode() {
                const $time = $('#resendAuth');
                $time.empty();
                const $min = $("<span id='resendAuthMinTime'>00</span>");
                const $sec = $("<span id='resendAuthSecTime'>15</span>");
                $time.append('<span>재전송 :&nbsp</span> ', $min, ' : ', $sec);
                resendAuthIntervalId = setInterval(() => {
                    resendAuthCodeTime($time, $min, $sec);
                }, 1000);
            }
            // 인증번호 만료 시간
            function resendAuthCodeTime($time, $min, $sec) {
                const min = $min.text();
                const sec = $sec.text();
                if (sec == '00') {
                    if (min != '00') {
                        const newMin = Number(min) - 1;
                        $min.text('0' + newMin);
                        $sec.text('59');
                    } else {
                        clearInterval(resendAuthIntervalId);
                        $time.empty();
                        $time.text('전송 가능');
                        resendAuthResult = true;
                    }
                } else {
                    const newSec = Number(sec) - 1;
                    if (newSec < 10) {
                        $sec.text('0' + newSec);
                    } else {
                        $sec.text(newSec);
                    }
                }
            }

            function authCode() {
                const $time = $('#authCodeTime'); // 시간을 가지고 있는 요소
                $time.empty();
                const $min = $("<span id='authMinTime'>03</span>");
                const $sec = $("<span id='authSecTime'>00</span>");
                $time.append($min, ' : ', $sec);

                const $phoneArea = $('.phoneArea');
                $phoneArea.show();
                authIntervalId = setInterval(() => {
                    authCodeTime($time, $min, $sec);
                }, 1000);
            }

            // 인증번호 만료 시간
            function authCodeTime($time, $min, $sec) {
                const min = $min.text();
                const sec = $sec.text();
                if (sec == '00') {
                    if (min != '00') {
                        const newMin = Number(min) - 1;
                        $min.text('0' + newMin);
                        $sec.text('59');
                    } else {
                        clearInterval(authIntervalId);
                        $time.empty();
                        $time.text('인증 시간이 만료되었습니다.');
                    }
                } else {
                    const newSec = Number(sec) - 1;
                    if (newSec < 10) {
                        $sec.text('0' + newSec);
                    } else {
                        $sec.text(newSec);
                    }
                }
            }

            // 인증번호 확인 버튼
            $('#authCodeChk').on('click', function () {
                const authCode = $('#authCode').val();
                if (authCode == '1111') {
                    console.log('일치합니다');
                    clearInterval(authIntervalId);
                    clearInterval(resendAuthIntervalId);
                    $('#resendAuth').empty().text('인증성공');
                    feedback($('#resendAuth'), true);
                    $('.phoneArea').hide();
                    $('#authCodeSend').addClass('disabled');
                    $('#memberPhone').attr('readonly', true);
                } else {
                    showErrorAlert('인증 번호를 다시 확인해주세요.');
                }
            });

            // 주소
            $('#memberAddress').on('change', function () {});

            $('#addressDetail').on('change', function () {});

            document.getElementById('memberJuminBack').addEventListener('input', function () {
                let v = this.value.replace(/\D/g, ''); // 숫자만
                this.value = v.substring(0, 1); // 1자리만 유지
            });
        </script>

        <script th:inline="javascript"></script>
    </body>
</html>
