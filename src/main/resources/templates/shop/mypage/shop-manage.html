<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{shop/mypage/shop-mypage-layout}">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- JQuery CDN -->
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <!-- SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SweetAlert 공통 래퍼 -->
    <script th:src="@{/js/comm/sweetalert.noah.js}"></script>
    <!-- Kakao Postcode API -->
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <title>상점 관리</title>

    <style>
        .page-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 30px;
        }
        .info-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }
        .info-row label {
            width: 100px;
            font-weight: 600;
        }
        .info-row input {
            width: 300px;
            padding: 6px;
            border: 1px solid #000;
            border-radius: 4px;
        }
        .info-row button {
            padding: 6px 12px;
            border: 1px solid #000;
            background: #fff;
            cursor: pointer;
            border-radius: 4px;
        }

        /* 휴무일 버튼 */
        .day-btn {
            padding: 6px 10px;
            border: 1px solid #000;
            background: #fff;
            cursor: pointer;
            border-radius: 4px;
        }
        .day-btn.active {
            background: #000;
            color: #fff;
        }
    </style>
</head>

<body>
<section layout:fragment="content">
    <div class="page-title">상점관리</div>

    <!-- 상점명 -->
    <div class="info-row">
        <label>상점명</label>
        <input id="shopName" th:value="${shop.shopName}" readonly>
        <button type="button" onclick="toggleEdit(this, 'shopName','name')">변경</button>
    </div>

    <!-- 소개글 -->
    <div class="info-row">
        <label>소개글</label>
        <input id="shopIntro" th:value="${shop.shopIntro}" readonly>
        <button type="button" onclick="toggleEdit(this, 'shopIntro','intro')">변경</button>
    </div>

    <!-- 주소 (Kakao API 연결 예정) -->
    <div class="info-row">
        <label>주소</label>
        <input id="shopAddress" th:value="${shop.shopAddress}" readonly>
        <button type="button" onclick="openAddress()">변경</button>
    </div>

    <!-- 휴무일 -->
    <div class="info-row">
        <label>휴무일</label>

        <div id="holidayButtons">
            <button type="button" class="day-btn" data-day="월">월</button>
            <button type="button" class="day-btn" data-day="화">화</button>
            <button type="button" class="day-btn" data-day="수">수</button>
            <button type="button" class="day-btn" data-day="목">목</button>
            <button type="button" class="day-btn" data-day="금">금</button>
            <button type="button" class="day-btn" data-day="토">토</button>
            <button type="button" class="day-btn" data-day="일">일</button>
        </div>
        <!-- 기존 휴무일 값 전달용 -->
        <input type="hidden" id="savedHoliday" th:value="${shop.holiday}">
        <button type="button" onclick="saveHoliday()">저장</button>
    </div>

    <!-- 영업시간 -->
    <div class="info-row">
        <label>영업시간</label>
        <input type="time" id="openTime" th:value="${shop.openTime}" disabled>
        <span>~</span>
        <input type="time" id="closeTime" th:value="${shop.closeTime}" disabled>
        <button type="button" onclick="toggleTimeEdit()">변경</button>
    </div>

    <!-- 현재 영업 상태 -->
    <div style="margin-top:20px;">
        <strong>현재 상태 :</strong>
        <span th:text="${openStatus}"
              th:style="${openStatus == '영업중'} ? 'color:green;' :
                        (${openStatus == '휴무'} ? 'color:red;' : 'color:gray;')">
        </span>
    </div>
</section>

<script>
/* =========================
   공통 수정 (상점명/소개글/주소)
========================= */
function toggleEdit(btn, inputId, type) {
    const input = document.getElementById(inputId);

    // 수정 모드
    if (input.readOnly) {
        input.readOnly = false;
        input.focus();
        btn.textContent = '저장';
        return;
    }

    // 저장 모드
    fetch(`/shop/mypage/update/${type}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ value: input.value })
    })
    .then(res => res.json())
    .then(data => {
        if (data.result === 'OK') {
            showSuccessAlert('변경되었습니다.');
            input.readOnly = true;
            btn.textContent = '변경';
        } else {
            showErrorAlert(data.message || '변경에 실패했습니다.');
        }
    })
    .catch(() => showErrorAlert('서버 오류로 변경에 실패했습니다.'));
}
/* =========================
   주소 수정 (Kakao Postcode API)
   ========================= */
function openAddress() {
    new daum.Postcode({
        oncomplete: function(data) {

            // 1️. 선택한 주소
            const address = data.address;

            // 2️. 화면에 즉시 반영
            document.getElementById('shopAddress').value = address;

            // 3️. 서버 저장
            fetch('/shop/mypage/update/address', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    value: address
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.result === 'OK') {
                    showSuccessAlert('주소가 변경되었습니다.');
                } else {
                    showErrorAlert(data.message || '주소 변경 실패');
                }
            })
            .catch(() => showErrorAlert('서버 오류'));
        }
    }).open();
}

/* =========================
   휴무일
========================= */
const selectedDays = new Set();

/* 기존 휴무일 버튼 반영 */
const savedHoliday = document.getElementById('savedHoliday')?.value;

if (savedHoliday) {
    savedHoliday.split(',').forEach(day => {
        selectedDays.add(day);
        const btn = document.querySelector(`.day-btn[data-day="${day}"]`);
        if (btn) btn.classList.add('active');
    });
}

/* 휴무일 버튼 클릭 이벤트 */
document.querySelectorAll('.day-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const day = btn.dataset.day;
        btn.classList.toggle('active');

        if (selectedDays.has(day)) selectedDays.delete(day);
        else selectedDays.add(day);
    });
});

function saveHoliday() {
    fetch('/shop/mypage/update/holiday', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            // 아무것도 선택 안 하면 "" 저장
            value: Array.from(selectedDays).join(',')
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.result === 'OK') {
            showSuccessAlert(
                selectedDays.size === 0 ? '휴무일 없음으로 저장되었습니다.' : '휴무일이 저장되었습니다.');
        } else {
            showErrorAlert(data.message || '휴무일 저장에 실패했습니다.');
        }
    })
    .catch(() => showErrorAlert('서버 오류로 휴무일 저장에 실패했습니다.'));
}


/* =========================
   영업시간 수정
========================= */
let timeEditMode = false;

function toggleTimeEdit() {
    const open = document.getElementById('openTime');
    const close = document.getElementById('closeTime');

    // 수정 모드
    if (!timeEditMode) {
        open.disabled = false;
        close.disabled = false;
        timeEditMode = true;
        return;
    }

    // 유효성 검사
    if (!open.value || !close.value) {
        showErrorAlert('영업 시작 시간과 종료 시간을 모두 입력해주세요.');
        return;
    }

    if (open.value >= close.value) {
        showErrorAlert('영업 종료 시간은 시작 시간보다 늦어야 합니다.');
        return;
    }

    // 저장 모드
    fetch('/shop/mypage/update/time', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            value: open.value + " ~ " + close.value
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.result === 'OK') {
            showSuccessAlert('영업시간이 변경되었습니다.');
            open.disabled = true;
            close.disabled = true;
            timeEditMode = false;
        } else {
            showErrorAlert(data.message || '영업시간 변경에 실패했습니다.');
        }
    })
    .catch(() => showErrorAlert('서버 오류로 영업시간 변경에 실패했습니다.'));
}
</script>
</body>
</html>