<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{shop/common/shop-layout}">

<head>
    <meta charset="UTF-8" />
    <title>주문 관리 - 모두의빵 판매자센터</title>

    <style>
        /* ===== 기존 스타일 유지 ===== */
        .orders-container { width: 100%; padding: 25px; box-sizing: border-box; }
        .page-title { font-size: 22px; font-weight: 700; margin-bottom: 20px; }
        .top-controls { display: flex; align-items: center; gap: 8px; margin-bottom: 20px; }
        .date-input { padding: 7px; border: 1px solid #ccc; border-radius: 4px; }
        .btn { padding: 7px 14px; border: 1px solid #000; background: #fff; cursor: pointer; border-radius: 4px; font-size: 13px; }
        .btn:hover { background: #000; color: #fff; }

        .status-tabs { display: flex; margin-bottom: 20px; }
        .status-tab { flex: 1; padding: 10px; text-align: center; border: 1px solid #ddd; background: #f9f9f9; text-decoration: none; color: #000; }
        .status-tab.active { background: #000; color: #fff; font-weight: 600; }

        .order-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; background: #fff; }
        .order-row { display: flex; justify-content: space-between; align-items: center; }
        .order-left { display: flex; gap: 15px; }
        .order-img { width: 60px; height: 60px; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #777; }
        .order-info { display: flex; flex-direction: column; gap: 4px; font-size: 14px; }
        .order-date { color: #777; }
        .order-actions { display: flex; gap: 10px; align-items: center; }

        .pagination { text-align: center; margin-top: 30px; }
        .pagination a { margin: 0 4px; text-decoration: none; color: #000; }
        .pagination a.current { font-weight: bold; text-decoration: underline; }

        /* ===== 추가: 거절 모달 ===== */
        .modal {
            display: none; /* 기본 숨김 */
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #fff;
            padding: 20px;
            width: 400px;
            border-radius: 6px;
        }

        .modal-content h3 {
            margin-bottom: 10px;
        }

        .modal-content textarea {
            width: 100%;
            height: 100px;
            resize: none;
            margin-bottom: 15px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .text-reject {
            color: red;
            font-weight: 600;
        }
    </style>
</head>

<body>
<div layout:fragment="content">

    <div class="orders-container">

        <div class="page-title">주문 관리</div>

        <div>
            <!-- DASHBOARD 4개 박스 -->
             <div class="dashboard-box-wrapper">

                <div class="dashboard-box">
                    <div class="dash-title">오늘 주문</div>
                    <div class="dash-value" id="dash-today">0</div>
                </div>

                <div class="dashboard-box">
                    <div class="dash-title">대기 주문</div>
                    <div class="dash-value" id="dash-wait">0</div>
                </div>

                <div class="dashboard-box">
                    <div class="dash-title">배송 중</div>
                    <div class="dash-value" id="dash-delivering">0</div>
                </div>

                <div class="dashboard-box">
                    <div class="dash-title">완료 주문</div>
                    <div class="dash-value" id="dash-complete">0</div>
                </div>
        </div>

        <!-- 기간 필터 (더미 유지) -->
        <form class="top-controls">
            <input type="date" class="date-input">
            <span>~</span>
            <input type="date" class="date-input">
            <button type="button" class="btn">조회</button>
        </form>

        <!-- 상태 탭 (더미 유지) -->
        <div class="status-tabs">
            <!-- 전체 -->
            <a th:href="@{/shop/orders}"
            class="status-tab"
            th:classappend="${status == null} ? 'active'">
                전체
            </a>

            <!-- 대기 -->
            <a th:href="@{/shop/orders(status=WAIT)}"
            class="status-tab"
            th:classappend="${status != null and status.name() == 'WAIT'} ? 'active'">
                대기
            </a>

            <!-- 준비 -->
            <a th:href="@{/shop/orders(status=PREPARE)}"
            class="status-tab"
            th:classappend="${status != null and status.name() == 'PREPARE'} ? 'active'">
                준비
            </a>

            <!-- 배송중 -->
            <a th:href="@{/shop/orders(status=DELIVERING)}"
            class="status-tab"
            th:classappend="${status != null and status.name() == 'DELIVERING'} ? 'active'">
                배송중
            </a>

            <!-- 완료 -->
            <a th:href="@{/shop/orders(status=COMPLETE)}"
            class="status-tab"
            th:classappend="${status != null and status.name() == 'COMPLETE'} ? 'active'">
                완료
            </a>
        </div>

        <!-- ===== 주문 목록 ===== -->
        <!-- 주문이 없을 때 -->
        <div th:if="${#lists.isEmpty(orders)}" class="order-card">
            <div>주문이 없습니다.</div>
        </div>
        <!-- 주문이 있을 때 -->
        <div th:each="order : ${orders}" class="order-card" th:onclick="|location.href='/shop/orders/${order.orderNo}'|" style="cursor:pointer;">

            <div class="order-row">

                <!-- 좌측: 주문 정보 -->
                <div class="order-left">
                    <div class="order-img">상품</div>

                    <div class="order-info">
                        <!-- 주문 날짜 -->
                        <div class="order-date"
                            th:text="${order.orderTime != null ? #temporals.format(order.orderTime.orderedAt, 'yyyy-MM-dd') : '-'}">
                        </div>

                        <!-- 상품 정보 -->
                        <div>
                            주문번호 :
                            <span th:text="${order.orderNo}"></span>
                        </div>

                        <!-- 총 금액 -->
                        <div>
                            총 금액 :
                            <span th:text="${#numbers.formatInteger(order.orderPrice, 3, 'COMMA')}"></span>원
                        </div>
                    </div>
                </div>

                <!-- 우측: 상태별 액션 -->
                <div class="order-actions">

                    <!-- 대기 -->
                    <th:block th:if="${order.status.name() == 'WAIT'}">
                        <form th:action="@{/shop/orders/{orderNo}/accept(orderNo=${order.orderNo})}"
                            method="post" onclick="event.stopPropagation();">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <button type="submit" class="btn">수락</button>
                        </form>

                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <button class="btn"
                                th:onclick="|openRejectModal(${order.orderNo})|" onclick="event.stopPropagation();">
                            거절
                        </button>
                    </th:block>

                    <!-- 준비 -->
                    <th:block th:if="${order.status.name() == 'PREPARE'}">
                        <span>상품 준비 중</span>
                    </th:block>

                    <!-- 배송중 -->
                    <th:block th:if="${order.status.name() == 'DELIVERING'}">
                        <span>배송 중</span>
                    </th:block>

                    <!-- 완료 -->
                    <th:block th:if="${order.status.name() == 'COMPLETE'}">
                        <span>배송 완료</span>
                    </th:block>

                    <!-- 거절 -->
                    <th:block th:if="${order.status.name() == 'REJECT'}">
                        <span class="text-reject">주문 거절</span>
                    </th:block>

                </div>
            </div>
        </div>


        <!-- 페이징 (더미) -->
        <div class="pagination">
            <a href="#">◀</a>
            <a href="#" class="current">1</a>
            <a href="#">2</a>
            <a href="#">▶</a>
        </div>

    </div>
</div>

<!-- ===== 거절 모달 ===== -->
<div class="modal" id="rejectModal">
    <div class="modal-content">
        <h3>주문 거절</h3>

        <!-- 실제 서버 연동 시 action만 바꾸면 됨 -->
        <form method="post" id="rejectForm">
            <input type="hidden" name="orderNo" id="rejectOrderNo">
            <textarea name="reason" placeholder="거절 사유를 입력해주세요." required></textarea>

            <div class="modal-actions">
                <button type="button" class="btn" onclick="closeRejectModal()">취소</button>
                <button type="submit" class="btn">거절</button>
            </div>
        </form>
    </div>
</div>

<script>
    // =========================
    // 주문 거절 모달
    // =========================
    function openRejectModal(orderNo) {
        // 모달 열기
        const modal = document.getElementById('rejectModal');
        // 폼 액션 설정
        const form = document.getElementById('rejectForm');
        // 숨겨진 input에 주문 번호 설정
        form.action = `/shop/orders/${orderNo}/reject`;
        modal.style.display = 'flex';
    }

    // 모달 닫기
    function closeRejectModal() {
        document.getElementById('rejectModal').style.display = 'none';
    }

    // =========================
    // 주문 대시보드 AJAX
    // =========================
    function loadOrderDashboard() {
        // 대시보드 데이터 요청
        fetch('/shop/orders/dashboard')
            // 응답을 JSON으로 파싱
            .then(response => response.json())
            .then(data => {
                document.getElementById('dash-today').innerText = data.today;           // 오늘 주문 수
                document.getElementById('dash-wait').innerText = data.wait;             // 대기 주문 수
                document.getElementById('dash-delivering').innerText = data.delivering; // 배송 중 주문 수
                document.getElementById('dash-complete').innerText = data.complete;     // 완료 주문 수
            })
            // 에러 처리
            .catch(err => console.error('대시보드 로딩 실패', err));
    }

    // 페이지 로드 시 1회 실행
    document.addEventListener('DOMContentLoaded', () => {
        loadOrderDashboard();
        // 5분마다 갱신
        setInterval(loadOrderDashboard, 300000);
    });

</script>
</body>
</html>